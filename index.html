<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½“è´¨å¥åº· & è§†åŠ›åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif; background-color: #f2f2f2; font-size: 13px; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .toolbar { background: #217346; color: white; padding: 8px 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; min-height: 50px; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 60; }
        .app-title { font-weight: bold; font-size: 1.2rem; margin-right: 15px; white-space: nowrap; }
        .btn { background: #f3f3f3; border: 1px solid #ccc; color: #333; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; white-space: nowrap; user-select: none; transition: all 0.1s; }
        .btn:active { background: #e0e0e0; transform: translateY(1px); }
        .btn-green { background: #4caf50; color: white; border: none; }
        .btn-red { background: #f44336; color: white; border: none; }
        .btn-blue { background: #2196f3; color: white; border: none; }
        .btn-purple { background: #9c27b0; color: white; border: none; }
        .btn-orange { background: #ff9800; color: white; border: none; }
        .btn-teal { background: #009688; color: white; border: none; }
        .btn-warn-nav { background: #d32f2f; color: white; border: 2px solid white; animation: pulse 2s infinite; display: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .pagination { display: flex; align-items: center; gap: 5px; margin-left: auto; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
        .page-info { font-size: 13px; color: #fff; font-weight: bold; font-family: monospace; min-width: 150px; text-align: center; }
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #ccc; padding-left: 10px; height: 40px; align-items: flex-end; flex-shrink: 0; }
        .tab { padding: 8px 25px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 4px 4px 0 0; color: #666; font-size: 14px; margin-right: 2px; }
        .tab.active { border-color: #ccc; border-bottom-color: #fff; background: #fff; color: #217346; font-weight: bold; margin-bottom: -1px; z-index: 5; }
        .tab.active-vision { color: #009688; }
        .excel-container { flex: 1; overflow: auto; background: white; border-top: 1px solid #d4d4d4; position: relative; scroll-behavior: smooth; }
        
        /* æ ¸å¿ƒä¿®å¤ï¼šè¡¨æ ¼å¸ƒå±€ */
        table { table-layout: fixed !important; width: max-content !important; min-width: 100%; border-collapse: separate; border-spacing: 0; border-left: 1px solid #a0a0a0; }
        th, td { border-right: 1px solid #a0a0a0; border-bottom: 1px solid #a0a0a0; padding: 0; text-align: center; height: 34px; box-sizing: border-box; overflow: hidden; background: #fff; }
        
        thead tr:first-child th { position: sticky; top: 0; z-index: 50; height: 35px; border-bottom: 1px solid #a0a0a0; }
        thead tr:last-child th { position: sticky; top: 35px; z-index: 50; height: 35px; border-bottom: 3px solid #444 !important; }
        #visionTable thead tr th { top: 0 !important; height: 40px !important; border-bottom: 3px solid #444 !important; z-index: 55; }

        .col-id { width: 60px; } .col-class { width: 90px; } .col-code { width: 140px; } .col-name { width: 70px; }
        .col-addr { width: 200px; } .col-std { width: 65px; } .col-w-xs { width: 50px; } .col-dob { width: 90px; }
        .col-vision { width: 75px; } .col-ok { width: 80px; }
        
        input.cell-input { width: 100%; height: 100%; border: none; outline: none; text-align: center; background: transparent; font-family: inherit; font-size: 13px; color: #000; font-weight: 500; }
        input[disabled] { background-color: #f9f9f9; color: #ccc; cursor: not-allowed; }
        tbody tr:focus-within td { background-color: #fff9c4 !important; }
        .modified-data { background-color: #d1fae5 !important; }
        .cell-warn { background-color: #ffebee !important; border: 2px solid #ef5350 !important; }
        .bg-header-base { background-color: #ffffff; color: #000; font-weight: bold; }
        .bg-header-score { background-color: #ffff00; color: #000; font-weight: bold; }
        .bg-header-vision { background-color: #e0f2f1; color: #00695c; font-weight: bold; }
        .text-exc { color: #008000; font-weight: bold; } .text-good { color: #0000ff; font-weight: bold; }
        .text-good { color: #0000ff; font-weight: bold; }
        .text-pass { color: #333; } .text-fail { color: #ff0000; font-weight: bold; background-color: #fff0f0; }
        .text-bmi-norm { color: #008000; font-weight: bold; } .text-bmi-warn { color: #ff9800; font-weight: bold; }
        .text-bmi-bad { color: #ff0000; font-weight: bold; background-color: #ffebee; }
        .text-total { color: #ff0000; font-weight: bold; font-size: 14px; text-decoration: underline; }
        .hidden { display: none !important; }
        .report-section { padding: 15px; background: white; overflow: auto; flex: 1; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .report-table th, .report-table td { border: 1px solid #000; padding: 6px 4px; text-align: center; }
       .report-header-blue th {
    background-color: #00b0f0 !important;
    color: white !important;
    font-weight: bold !important;
}
        .report-title { font-size: 16px; font-weight: bold; margin: 20px 0 10px; border-left: 6px solid #00b0f0; padding-left: 12px; color: #333; }
        @media (max-width: 640px) {
            .toolbar { justify-content: space-between; } .btn { flex-grow: 1; justify-content: center; padding: 8px; font-size: 12px;}
            .app-title { width: 100%; text-align: center; margin-bottom: 5px; margin-right: 0; } .pagination { width: 100%; justify-content: space-between; margin-top: 5px; order: 10; }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <span class="app-title">ğŸ“Š ä½“è´¨ & è§†åŠ›ä¸­å¿ƒ</span>
        <input type="file" id="infoInput" accept=".xlsx,.xls" style="display:none" onchange="importBasicInfo(event)">
        <button class="btn btn-blue" onclick="document.getElementById('infoInput').click()">1ï¸âƒ£ å¯¼å…¥å­¦ç±ä¿¡æ¯</button>
        
        <div id="group-tice" class="flex gap-2 items-center flex-wrap" style="display:flex;">
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="importExcel(event)">
            <button class="btn" onclick="document.getElementById('fileInput').click()">3ï¸âƒ£ å¯¼å…¥ä½“æµ‹æˆç»©</button>
            <button class="btn btn-orange" onclick="runSmartCheck()">4ï¸âƒ£ ğŸ” æ™ºèƒ½æ ¡éªŒ</button>
            <button class="btn btn-purple" onclick="openOptimizeDialog()">5ï¸âƒ£ âš¡ é»‘ç§‘æŠ€</button>
            <button class="btn btn-warn-nav" id="btnWarnNav" onclick="scrollToNextWarn()">âš ï¸ å®šä½å¼‚å¸¸ (0)</button>
            <button class="btn btn-green" onclick="exportClassInfo()">ğŸ“‚ å¯¼å‡ºç­çº§ä¿¡æ¯</button>
            <button class="btn btn-green" onclick="exportAllBasicInfo()">6ï¸âƒ£ å¯¼å‡ºåŸºæœ¬ä¿¡æ¯</button>
            <button class="btn btn-green" onclick="exportAllData()">7ï¸âƒ£ å¯¼å‡ºä¸ŠæŠ¥è¡¨</button>
            <button class="btn btn-green" onclick="openEnvSettings()">8ï¸âƒ£ å¯¼å‡ºç¯å¢ƒä¿¡æ¯</button>
            <button class="btn " onclick="exportEmptyTemplate()">2ï¸âƒ£ ğŸ“‚ åˆ†ç­å¯¼å‡º (æµ‹è¯•è¡¨)</button>
            <button class="btn btn-blue" onclick="exportScoreTable()">ğŸ“Š åˆ†ç­å¯¼å‡º (å¸¦è¯„åˆ†)</button>
            <button class="btn btn-blue" onclick="exportAnalysisExcel()">ğŸ“Š å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š</button>
        </div>

        <div id="group-vision" class="gap-2 items-center flex-wrap" style="display:none;">
            <input type="file" id="visionInput" accept=".xlsx,.xls" style="display:none" onchange="importVisionExcel(event)">
            <button class="btn btn-teal" onclick="document.getElementById('visionInput').click()">ğŸ‘ï¸ å¯¼å…¥è§†åŠ›æ•°æ®</button>
            <button class="btn btn-teal" onclick="exportVisionData()">ğŸ“¤ å¯¼å‡ºè§†åŠ›æ•°æ®</button>
        </div>

        <button class="btn btn-red" onclick="deleteEmptyRows()">ğŸ—‘ï¸ æ¸…ç†æ— å­¦ç±æ— æˆç»©</button>
        <button class="btn btn-red" onclick="deleteCurrentClass()">ğŸ—‘ï¸ åˆ å½“å‰ç­</button>
        <button class="btn btn-red" onclick="clearTable()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
        
        <div class="pagination">
            <button class="btn" onclick="changeClass(-1)">â—€ ä¸Šä¸€ç­</button>
            <span id="page-info" class="page-info">æš‚æ— æ•°æ®</span>
            <button class="btn" onclick="changeClass(1)">ä¸‹ä¸€ç­ â–¶</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchView('data')" id="tab-data">ğŸƒ ä½“æµ‹æ•°æ®ç®¡ç†</div>
        <div class="tab" onclick="switchView('vision')" id="tab-vision">ğŸ‘ï¸ è§†åŠ›æ•°æ®ç®¡ç†</div>
        <div class="tab" onclick="switchView('report')" id="tab-report">ğŸ“Š ä½“æµ‹åˆ†ææŠ¥å‘Š</div>
        
    </div>

    <div id="view-data" class="excel-container">
        <table id="mainTable">
            <thead>
                <tr>
                    <th rowspan="2" class="bg-header-base col-id">å¹´çº§<br>ç¼–å·</th>
                    <th rowspan="2" class="bg-header-base col-id">ç­çº§<br>ç¼–å·</th>
                    <th rowspan="2" class="bg-header-base col-class">ç­çº§<br>åç§°</th>
                    <th rowspan="2" class="bg-header-base col-code">å­¦ç±å·</th>
                    <th rowspan="2" class="bg-header-base col-w-xs">æ°‘æ—</th>
                    <th rowspan="2" class="bg-header-base col-name">å§“å</th>
                    <th rowspan="2" class="bg-header-base col-w-xs">æ€§åˆ«</th>
                    <th rowspan="2" class="bg-header-base col-dob">å‡ºç”Ÿæ—¥æœŸ</th>
                    <th rowspan="2" class="bg-header-base col-addr">å®¶åº­ä½å€</th>
                    <th rowspan="2" class="bg-header-base col-std">èº«é«˜<br>(cm)</th>
                    <th rowspan="2" class="bg-header-base col-std">ä½“é‡<br>(kg)</th>
                    <th rowspan="2" class="bg-header-base col-std">è‚ºæ´»é‡<br>(ml)</th>
                    <th rowspan="2" class="bg-header-base col-std">50ç±³è·‘<br>(s)</th>
                    <th rowspan="2" class="bg-header-base col-std">åä½<br>ä½“å‰å±ˆ</th>
                    <th rowspan="2" class="bg-header-base col-std">ä»°å§<br>èµ·å</th>
                    <th rowspan="2" class="bg-header-base col-std">ç«‹å®š<br>è·³è¿œ</th>
                    <th rowspan="2" class="bg-header-base col-std">å¼•ä½“<br>å‘ä¸Š</th>
                    <th rowspan="2" class="bg-header-base col-std">1000ç±³</th>
                    <th rowspan="2" class="bg-header-base col-std">800ç±³</th>
                    <th colspan="2" class="bg-header-score">BMI</th>
                    <th colspan="2" class="bg-header-score">è‚ºæ´»é‡</th>
                    <th colspan="2" class="bg-header-score">50ç±³è·‘</th>
                    <th colspan="2" class="bg-header-score">ç«‹å®šè·³è¿œ</th>
                    <th colspan="2" class="bg-header-score">ä½“å‰å±ˆ</th>
                    <th colspan="2" class="bg-header-score">800ç±³</th>
                    <th colspan="2" class="bg-header-score">1000ç±³</th>
                    <th colspan="2" class="bg-header-score">ä»°å§èµ·å</th>
                    <th colspan="2" class="bg-header-score">å¼•ä½“å‘ä¸Š</th>
                    <th rowspan="2" class="bg-header-score col-w-xs">åŠ åˆ†</th>
                    <th rowspan="2" class="bg-header-score col-std" style="color:red">æ€»åˆ†</th>
                    <th rowspan="2" class="bg-header-score col-std">ç­‰çº§</th>
                    <th rowspan="2" class="bg-header-base col-w-xs">åˆ </th>
                </tr>
                <tr id="subHeader"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="view-report" class="report-section hidden">
        <div class="report-title">1. å…¨æ ¡æ•°æ®æ±‡æ€»</div>
        <div id="report-overall" style="overflow-x:auto;"></div>
        <div style="height: 350px;"><canvas id="chart-overall"></canvas></div> 
        <div class="report-title">2. å„é¡¹ç›®ä¼˜è‰¯ç‡ (ç”·å¥³åˆ†é¡¹)</div>
        <div id="report-items" style="overflow-x:auto;"></div>
        <div style="height: 350px;"><canvas id="chart-items"></canvas></div>
        <div class="report-title">3. ç­çº§è¯¦æƒ…åˆ†æ</div>
        <div id="report-class" style="overflow-x:auto;"></div>
        <div style="height: 350px;"><canvas id="chart-class"></canvas></div> 
    </div>

    <div id="view-vision" class="excel-container hidden">
        <table id="visionTable">
            <thead>
                <tr>
                    <th class="bg-header-base col-id">å¹´çº§<br>ç¼–å·</th>
                    <th class="bg-header-base col-id">ç­çº§<br>ç¼–å·</th>
                    <th class="bg-header-base col-class">ç­çº§åç§°</th>
                    <th class="bg-header-base col-code">å­¦ç±å·</th>
                    <th class="bg-header-base col-w-xs">æ°‘æ—</th>
                    <th class="bg-header-base col-name">å§“å</th>
                    <th class="bg-header-base col-w-xs">æ€§åˆ«</th>
                    <th class="bg-header-base col-dob">å‡ºç”Ÿæ—¥æœŸ</th>
                    <th class="bg-header-base col-addr">å®¶åº­ä½å€</th>
                    <th class="bg-header-vision col-vision" style="background:#f3e8ff">å³è£¸çœ¼</th>
                    <th class="bg-header-vision col-vision" style="background:#f3e8ff">å·¦è£¸çœ¼</th>
                    <th class="bg-header-vision col-vision">å³çƒé•œS</th>
                    <th class="bg-header-vision col-vision">å³æŸ±é•œC</th>
                    <th class="bg-header-vision col-vision">å³è½´ä½A</th>
                    <th class="bg-header-vision col-vision">å·¦çƒé•œS</th>
                    <th class="bg-header-vision col-vision">å·¦æŸ±é•œC</th>
                    <th class="bg-header-vision col-vision">å·¦è½´ä½A</th>
                    <th class="bg-header-vision col-ok">OKé•œ</th>
                    <th class="bg-header-base col-w-xs">åˆ </th>
                </tr>
            </thead>
            <tbody id="visionTableBody"></tbody>
        </table>
    </div>

<script>
// å…¨å±€é”™è¯¯æ•æ‰ï¼Œé˜²æ­¢è„šæœ¬é™é»˜å¤±è´¥
window.onerror = function(msg, url, line) {
    alert("ç³»ç»Ÿæ£€æµ‹åˆ°è„šæœ¬é”™è¯¯ï¼Œå¯èƒ½æ˜¯å¤åˆ¶ç²˜è´´ä¸å®Œæ•´å¯¼è‡´çš„ï¼š\n" + msg + "\nè¡Œå·ï¼š" + line);
    return false;
};

// =================é…ç½®åŒº=================
const STDS = {
    weights: { bmi:0.15, lung:0.15, run50:0.20, jump:0.10, sit:0.10, runL:0.20, str:0.10 },
    bmi: { "åˆä¸€ç”·": [15.4, 22.1, 24.9], "åˆä¸€å¥³": [14.7, 21.7, 24.4], "åˆäºŒç”·": [15.6, 22.5, 25.2], "åˆäºŒå¥³": [15.2, 22.2, 24.8], "åˆä¸‰ç”·": [15.7, 22.8, 26.0], "åˆä¸‰å¥³": [15.9, 22.6, 25.1], "é«˜ä¸€ç”·": [16.4, 23.2, 26.3], "é«˜ä¸€å¥³": [16.4, 22.7, 25.2], "é«˜äºŒç”·": [16.7, 23.7, 26.5], "é«˜äºŒå¥³": [16.8, 23.2, 25.4], "é«˜ä¸‰ç”·": [17.2, 23.8, 27.3], "é«˜ä¸‰å¥³": [17.0, 23.3, 25.7] },
    lung: { "åˆä¸€ç”·": [[3640,100],[3520,95],[3400,90],[3150,85],[2900,80],[2780,78],[2660,76],[2540,74],[2420,72],[2300,70],[2180,68],[2060,66],[1940,64],[1820,62],[1700,60],[1600,50],[1500,40],[1400,30],[1300,20],[1200,10]], "åˆäºŒç”·": [[3940,100],[3820,95],[3700,90],[3450,85],[3200,80],[3080,78],[2960,76],[2840,74],[2720,72],[2600,70],[2480,68],[2360,66],[2240,64],[2120,62],[2000,60],[1890,50],[1780,40],[1670,30],[1560,20],[1450,10]], "åˆä¸‰ç”·": [[4240,100],[4120,95],[4000,90],[3750,85],[3500,80],[3380,78],[3260,76],[3140,74],[3020,72],[2900,70],[2780,68],[2660,66],[2540,64],[2420,62],[2300,60],[2180,50],[2060,40],[1940,30],[1820,20],[1700,10]], "é«˜ä¸€ç”·": [[4540,100],[4420,95],[4300,90],[4050,85],[3800,80],[3680,78],[3560,76],[3440,74],[3320,72],[3200,70],[3080,68],[2960,66],[2840,64],[2720,62],[2600,60],[2470,50],[2340,40],[2210,30],[2080,20],[1950,10]], "é«˜äºŒç”·": [[4740,100],[4620,95],[4500,90],[4250,85],[4000,80],[3880,78],[3760,76],[3640,74],[3520,72],[3400,70],[3280,68],[3160,66],[3040,64],[2920,62],[2800,60],[2660,50],[2520,40],[2380,30],[2240,20],[2100,10]], "é«˜ä¸‰ç”·": [[4940,100],[4820,95],[4700,90],[4450,85],[4200,80],[4080,78],[3960,76],[3840,74],[3720,72],[3600,70],[3480,68],[3360,66],[3240,64],[3120,62],[3000,60],[2850,50],[2700,40],[2550,30],[2400,20],[2250,10]], "åˆä¸€å¥³": [[2750,100],[2650,95],[2550,90],[2450,85],[2350,80],[2250,78],[2150,76],[2050,74],[1950,72],[1850,70],[1750,68],[1650,66],[1550,64],[1450,62],[1350,60],[1310,50],[1270,40],[1230,30],[1190,20],[1150,10]], "åˆäºŒå¥³": [[2900,100],[2850,95],[2800,90],[2650,85],[2500,80],[2400,78],[2300,76],[2200,74],[2100,72],[2000,70],[1900,68],[1800,66],[1700,64],[1600,62],[1500,60],[1460,50],[1420,40],[1380,30],[1340,20],[1300,10]], "åˆä¸‰å¥³": [[3050,100],[3000,95],[2950,90],[2800,85],[2650,80],[2550,78],[2450,76],[2350,74],[2250,72],[2150,70],[2050,68],[1950,66],[1850,64],[1750,62],[1650,60],[1610,50],[1570,40],[1530,30],[1490,20],[1450,10]], "é«˜ä¸€å¥³": [[3150,100],[3100,95],[3050,90],[2900,85],[2750,80],[2650,78],[2550,76],[2450,74],[2350,72],[2250,70],[2150,68],[2050,66],[1950,64],[1850,62],[1750,60],[1710,50],[1670,40],[1630,30],[1590,20],[1550,10]], "é«˜äºŒå¥³": [[3250,100],[3200,95],[3150,90],[3000,85],[2850,80],[2750,78],[2650,76],[2550,74],[2450,72],[2350,70],[2250,68],[2150,66],[2050,64],[1950,62],[1850,60],[1810,50],[1770,40],[1730,30],[1690,20],[1650,10]], "é«˜ä¸‰å¥³": [[3350,100],[3300,95],[3250,90],[3100,85],[2950,80],[2850,78],[2750,76],[2650,74],[2550,72],[2450,70],[2350,68],[2250,66],[2150,64],[2050,62],[1950,60],[1910,50],[1870,40],[1830,30],[1790,20],[1750,10]] },
    run50: { "åˆä¸€ç”·": [[7.8,100],[7.9,95],[8,90],[8.1,85],[8.2,80],[8.4,78],[8.6,76],[8.8,74],[9,72],[9.2,70],[9.4,68],[9.6,66],[9.8,64],[10,62],[10.2,60],[10.4,50],[10.6,40],[10.8,30],[11,20],[11.2,10]], "åˆäºŒç”·": [[7.5,100],[7.6,95],[7.7,90],[7.8,85],[7.9,80],[8.1,78],[8.3,76],[8.5,74],[8.7,72],[8.9,70],[9.1,68],[9.3,66],[9.5,64],[9.7,62],[9.9,60],[10.1,50],[10.3,40],[10.5,30],[10.7,20],[10.9,10]], "åˆä¸‰ç”·": [[7.3,100],[7.4,95],[7.5,90],[7.6,85],[7.7,80],[7.9,78],[8.1,76],[8.3,74],[8.5,72],[8.7,70],[8.9,68],[9.1,66],[9.3,64],[9.5,62],[9.7,60],[9.9,50],[10.1,40],[10.3,30],[10.5,20],[10.7,10]], "é«˜ä¸€ç”·": [[7.1,100],[7.2,95],[7.3,90],[7.4,85],[7.5,80],[7.7,78],[7.9,76],[8.1,74],[8.3,72],[8.5,70],[8.7,68],[8.9,66],[9.1,64],[9.3,62],[9.5,60],[9.7,50],[9.9,40],[10.1,30],[10.3,20],[10.5,10]], "é«˜äºŒç”·": [[7,100],[7.1,95],[7.2,90],[7.3,85],[7.4,80],[7.6,78],[7.8,76],[8,74],[8.2,72],[8.4,70],[8.6,68],[8.8,66],[9,64],[9.2,62],[9.4,60],[9.6,50],[9.8,40],[10,30],[10.2,20],[10.4,10]], "é«˜ä¸‰ç”·": [[6.8,100],[6.9,95],[7,90],[7.1,85],[7.2,80],[7.4,78],[7.6,76],[7.8,74],[8,72],[8.2,70],[8.4,68],[8.6,66],[8.8,64],[9,62],[9.2,60],[9.4,50],[9.6,40],[9.8,30],[10,20],[10.2,10]], "åˆä¸€å¥³": [[8.1,100],[8.2,95],[8.3,90],[8.6,85],[8.9,80],[9.1,78],[9.3,76],[9.5,74],[9.7,72],[9.9,70],[10.1,68],[10.3,66],[10.5,64],[10.7,62],[10.9,60],[11.1,50],[11.3,40],[11.5,30],[11.7,20],[11.9,10]], "åˆäºŒå¥³": [[8,100],[8.1,95],[8.2,90],[8.5,85],[8.8,80],[9,78],[9.2,76],[9.4,74],[9.6,72],[9.8,70],[10,68],[10.2,66],[10.4,64],[10.6,62],[10.8,60],[11,50],[11.2,40],[11.4,30],[11.6,20],[11.8,10]], "åˆä¸‰å¥³": [[7.9,100],[8,95],[8.1,90],[8.4,85],[8.7,80],[8.9,78],[9.1,76],[9.3,74],[9.5,72],[9.7,70],[9.9,68],[10.1,66],[10.3,64],[10.5,62],[10.7,60],[10.9,50],[11.1,40],[11.3,30],[11.5,20],[11.7,10]], "é«˜ä¸€å¥³": [[7.8,100],[7.9,95],[8,90],[8.3,85],[8.6,80],[8.8,78],[9,76],[9.2,74],[9.4,72],[9.6,70],[9.8,68],[10,66],[10.2,64],[10.4,62],[10.6,60],[10.8,50],[11,40],[11.2,30],[11.4,20],[11.6,10]], "é«˜äºŒå¥³": [[7.7,100],[7.8,95],[7.9,90],[8.2,85],[8.5,80],[8.7,78],[8.9,76],[9.1,74],[9.3,72],[9.5,70],[9.7,68],[9.9,66],[10.1,64],[10.3,62],[10.5,60],[10.7,50],[10.9,40],[11.1,30],[11.3,20],[11.5,10]], "é«˜ä¸‰å¥³": [[7.6,100],[7.7,95],[7.8,90],[8.1,85],[8.4,80],[8.6,78],[8.8,76],[9,74],[9.2,72],[9.4,70],[9.6,68],[9.8,66],[10,64],[10.2,62],[10.4,60],[10.6,50],[10.8,40],[11,30],[11.2,20],[11.4,10]] },
    sit: { "åˆä¸€ç”·": [[17.6,100],[15.9,95],[14.2,90],[12.3,85],[10.4,80],[9.1,78],[7.8,76],[6.5,74],[5.2,72],[3.9,70],[2.6,68],[1.3,66],[0,64],[-1.3,62],[-2.6,60],[-3.8,50],[-5,40],[-6.2,30],[-7.4,20],[-8.6,10]], "åˆäºŒç”·": [[19.6,100],[17.7,95],[15.8,90],[13.7,85],[11.6,80],[10.3,78],[9,76],[7.7,74],[6.4,72],[5.1,70],[3.8,68],[2.5,66],[1.2,64],[-0.1,62],[-1.4,60],[-2.6,50],[-3.8,40],[-5,30],[-6.2,20],[-7.4,10]], "åˆä¸‰ç”·": [[21.6,100],[19.7,95],[17.8,90],[15.8,85],[13.8,80],[12.4,78],[11,76],[9.6,74],[8.2,72],[6.8,70],[5.4,68],[4,66],[2.6,64],[1.2,62],[-0.2,60],[-1.4,50],[-2.6,40],[-3.8,30],[-5,20],[-6.2,10]], "é«˜ä¸€ç”·": [[23.6,100],[21.5,95],[19.4,90],[17.2,85],[15,80],[13.6,78],[12.2,76],[10.8,74],[9.4,72],[8,70],[6.6,68],[5.2,66],[3.8,64],[2.4,62],[1,60],[0,50],[-1,40],[-2,30],[-3,20],[-4,10]], "é«˜äºŒç”·": [[24.3,100],[22.4,95],[20.5,90],[18.3,85],[16.1,80],[14.7,78],[13.3,76],[11.9,74],[10.5,72],[9.1,70],[7.7,68],[6.3,66],[4.9,64],[3.5,62],[2.1,60],[1.1,50],[0.1,40],[-0.9,30],[-1.9,20],[-2.9,10]], "é«˜ä¸‰ç”·": [[24.6,100],[22.8,95],[21,90],[19.1,85],[17.2,80],[15.8,78],[14.4,76],[13,74],[11.6,72],[10.2,70],[8.8,68],[7.4,66],[6,64],[4.6,62],[3.2,60],[2.2,50],[1.2,40],[0.2,30],[-0.8,20],[-1.8,10]], "åˆä¸€å¥³": [[21.8,100],[20.1,95],[18.4,90],[16.7,85],[15,80],[13.7,78],[12.4,76],[11.1,74],[9.8,72],[8.5,70],[7.2,68],[5.9,66],[4.6,64],[3.3,62],[2,60],[1.2,50],[0.4,40],[-0.4,30],[-1.2,20],[-2,10]], "åˆäºŒå¥³": [[22.7,100],[21,95],[19.3,90],[17.6,85],[15.9,80],[14.6,78],[13.3,76],[12,74],[10.7,72],[9.4,70],[8.1,68],[6.8,66],[5.5,64],[4.2,62],[2.9,60],[2.1,50],[1.3,40],[0.5,30],[-0.3,20],[-1.1,10]], "åˆä¸‰å¥³": [[23.5,100],[21.8,95],[20.1,90],[18.4,85],[16.7,80],[15.4,78],[14.1,76],[12.8,74],[11.5,72],[10.2,70],[8.9,68],[7.6,66],[6.3,64],[5,62],[3.7,60],[2.9,50],[2.1,40],[1.3,30],[0.5,20],[-0.3,10]], "é«˜ä¸€å¥³": [[24.2,100],[22.5,95],[20.8,90],[19.1,85],[17.4,80],[16.1,78],[14.8,76],[13.5,74],[12.2,72],[10.9,70],[9.6,68],[8.3,66],[7,64],[5.7,62],[4.4,60],[3.6,50],[2.8,40],[2,30],[1.2,20],[0.4,10]], "é«˜äºŒå¥³": [[24.8,100],[23.1,95],[21.4,90],[19.7,85],[18,80],[16.7,78],[15.4,76],[14.1,74],[12.8,72],[11.5,70],[10.2,68],[8.9,66],[7.6,64],[6.3,62],[5,60],[4.2,50],[3.4,40],[2.6,30],[1.8,20],[1,10]], "é«˜ä¸‰å¥³": [[25.3,100],[23.6,95],[21.9,90],[20.2,85],[18.5,80],[17.2,78],[15.9,76],[14.6,74],[13.3,72],[12,70],[10.7,68],[9.4,66],[8.1,64],[6.8,62],[5.5,60],[4.7,50],[3.9,40],[3.1,30],[2.3,20],[1.5,10]] },
    jump: { "åˆä¸€ç”·": [[225,100],[218,95],[211,90],[203,85],[195,80],[191,78],[187,76],[183,74],[179,72],[175,70],[171,68],[167,66],[163,64],[159,62],[155,60],[150,50],[145,40],[140,30],[135,20],[130,10]], "åˆäºŒç”·": [[240,100],[233,95],[226,90],[218,85],[210,80],[206,78],[202,76],[198,74],[194,72],[190,70],[186,68],[182,66],[178,64],[174,62],[170,60],[165,50],[160,40],[155,30],[150,20],[145,10]], "åˆä¸‰ç”·": [[250,100],[245,95],[240,90],[233,85],[225,80],[221,78],[217,76],[213,74],[209,72],[205,70],[201,68],[197,66],[193,64],[189,62],[185,60],[180,50],[175,40],[170,30],[165,20],[160,10]], "é«˜ä¸€ç”·": [[260,100],[255,95],[250,90],[243,85],[235,80],[231,78],[227,76],[223,74],[219,72],[215,70],[211,68],[207,66],[203,64],[199,62],[195,60],[190,50],[185,40],[180,30],[175,20],[170,10]], "é«˜äºŒç”·": [[265,100],[260,95],[255,90],[248,85],[240,80],[236,78],[232,76],[228,74],[224,72],[220,70],[216,68],[212,66],[208,64],[204,62],[200,60],[195,50],[190,40],[185,30],[180,20],[175,10]], "é«˜ä¸‰ç”·": [[270,100],[265,95],[260,90],[253,85],[245,80],[241,78],[237,76],[233,74],[229,72],[225,70],[221,68],[217,66],[213,64],[209,62],[205,60],[200,50],[195,40],[190,30],[185,20],[180,10]], "åˆä¸€å¥³": [[196,100],[190,95],[184,90],[177,85],[170,80],[167,78],[164,76],[161,74],[158,72],[155,70],[152,68],[149,66],[146,64],[143,62],[140,60],[135,50],[130,40],[125,30],[120,20],[115,10]], "åˆäºŒå¥³": [[200,100],[194,95],[188,90],[181,85],[174,80],[171,78],[168,76],[165,74],[162,72],[159,70],[156,68],[153,66],[150,64],[147,62],[144,60],[139,50],[134,40],[129,30],[124,20],[119,10]], "åˆä¸‰å¥³": [[202,100],[196,95],[190,90],[183,85],[176,80],[173,78],[170,76],[167,74],[164,72],[161,70],[158,68],[155,66],[152,64],[149,62],[146,60],[141,50],[136,40],[131,30],[126,20],[121,10]], "é«˜ä¸€å¥³": [[204,100],[198,95],[192,90],[185,85],[178,80],[175,78],[172,76],[169,74],[166,72],[163,70],[160,68],[157,66],[154,64],[151,62],[148,60],[143,50],[138,40],[133,30],[128,20],[123,10]], "é«˜äºŒå¥³": [[205,100],[199,95],[193,90],[186,85],[179,80],[176,78],[173,76],[170,74],[167,72],[164,70],[161,68],[158,66],[155,64],[152,62],[149,60],[144,50],[139,40],[134,30],[129,20],[124,10]], "é«˜ä¸‰å¥³": [[206,100],[200,95],[194,90],[187,85],[180,80],[177,78],[174,76],[171,74],[168,72],[165,70],[162,68],[159,66],[156,64],[153,62],[150,60],[145,50],[140,40],[135,30],[130,20],[125,10]] },
    str: { "åˆä¸€ç”·": [[13,100],[12,95],[11,90],[10,85],[9,80],[8,76],[7,72],[6,68],[5,64],[4,60],[3,50],[2,40],[1,30]], "åˆäºŒç”·": [[14,100],[13,95],[12,90],[11,85],[10,80],[9,76],[8,72],[7,68],[6,64],[5,60],[4,50],[3,40],[2,30],[1,20]], "åˆä¸‰ç”·": [[15,100],[14,95],[13,90],[12,85],[11,80],[10,76],[9,72],[8,68],[7,64],[6,60],[5,50],[4,40],[3,30],[2,20],[1,10]], "é«˜ä¸€ç”·": [[16,100],[15,95],[14,90],[13,85],[12,80],[11,76],[10,72],[9,68],[8,64],[7,60],[6,50],[5,40],[4,30],[3,20],[2,10]], "é«˜äºŒç”·": [[17,100],[16,95],[15,90],[14,85],[13,80],[12,76],[11,72],[10,68],[9,64],[8,60],[7,50],[6,40],[5,30],[4,20],[3,10]], "é«˜ä¸‰ç”·": [[18,100],[17,95],[16,90],[15,85],[14,80],[13,76],[12,72],[11,68],[10,64],[9,60],[8,50],[7,40],[6,30],[5,20],[4,10]], "åˆä¸€å¥³": [[50,100],[48,95],[46,90],[43,85],[40,80],[38,78],[36,76],[34,74],[32,72],[30,70],[28,68],[26,66],[24,64],[22,62],[20,60],[18,50],[16,40],[14,30],[12,20],[10,10]], "åˆäºŒå¥³": [[51,100],[49,95],[47,90],[44,85],[41,80],[39,78],[37,76],[35,74],[33,72],[31,70],[29,68],[27,66],[25,64],[23,62],[21,60],[19,50],[17,40],[15,30],[13,20],[11,10]], "åˆä¸‰å¥³": [[52,100],[50,95],[48,90],[45,85],[42,80],[40,78],[38,76],[36,74],[34,72],[32,70],[30,68],[28,66],[26,64],[24,62],[22,60],[20,50],[18,40],[16,30],[14,20],[12,10]], "é«˜ä¸€å¥³": [[53,100],[51,95],[49,90],[46,85],[43,80],[41,78],[39,76],[37,74],[35,72],[33,70],[31,68],[29,66],[27,64],[25,62],[23,60],[21,50],[19,40],[17,30],[15,20],[13,10]], "é«˜äºŒå¥³": [[54,100],[52,95],[50,90],[47,85],[44,80],[42,78],[40,76],[38,74],[36,72],[34,70],[32,68],[30,66],[28,64],[26,62],[24,60],[22,50],[20,40],[18,30],[16,20],[14,10]], "é«˜ä¸‰å¥³": [[55,100],[53,95],[51,90],[48,85],[45,80],[43,78],[41,76],[39,74],[37,72],[35,70],[33,68],[31,66],[29,64],[27,62],[25,60],[23,50],[21,40],[19,30],[17,20],[15,10]] },
    runL: { "åˆä¸€ç”·": [[235,100],[245,95],[255,90],[262,85],[270,80],[275,78],[280,76],[285,74],[290,72],[295,70],[300,68],[305,66],[310,64],[315,62],[320,60],[340,50],[360,40],[380,30],[400,20],[420,10]], "åˆäºŒç”·": [[230,100],[235,95],[240,90],[247,85],[255,80],[260,78],[265,76],[270,74],[275,72],[280,70],[285,68],[290,66],[295,64],[300,62],[305,60],[325,50],[345,40],[365,30],[385,20],[405,10]], "åˆä¸‰ç”·": [[220,100],[225,95],[230,90],[237,85],[245,80],[250,78],[255,76],[260,74],[265,72],[270,70],[275,68],[280,66],[285,64],[290,62],[295,60],[315,50],[335,40],[355,30],[375,20],[395,10]], "é«˜ä¸€ç”·": [[210,100],[215,95],[220,90],[227,85],[235,80],[240,78],[245,76],[250,74],[255,72],[260,70],[265,68],[270,66],[275,64],[280,62],[285,60],[305,50],[325,40],[345,30],[365,20],[385,10]], "é«˜äºŒç”·": [[205,100],[210,95],[215,90],[222,85],[230,80],[235,78],[240,76],[245,74],[250,72],[255,70],[260,68],[265,66],[270,64],[275,62],[280,60],[300,50],[320,40],[340,30],[360,20],[380,10]], "é«˜ä¸‰ç”·": [[200,100],[205,95],[210,90],[217,85],[225,80],[230,78],[235,76],[240,74],[245,72],[250,70],[255,68],[260,66],[265,64],[270,62],[275,60],[295,50],[315,40],[335,30],[355,20],[375,10]], "åˆä¸€å¥³": [[215,100],[222,95],[229,90],[237,85],[245,80],[250,78],[255,76],[260,74],[265,72],[270,70],[275,68],[280,66],[285,64],[290,62],[295,60],[305,50],[315,40],[325,30],[335,20],[345,10]], "åˆäºŒå¥³": [[210,100],[217,95],[224,90],[232,85],[240,80],[245,78],[250,76],[255,74],[260,72],[265,70],[270,68],[275,66],[280,64],[285,62],[290,60],[300,50],[310,40],[320,30],[330,20],[340,10]], "åˆä¸‰å¥³": [[205,100],[212,95],[219,90],[227,85],[235,80],[240,78],[245,76],[250,74],[255,72],[260,70],[265,68],[270,66],[275,64],[280,62],[285,60],[295,50],[305,40],[315,30],[325,20],[335,10]], "é«˜ä¸€å¥³": [[204,100],[210,95],[216,90],[223,85],[230,80],[235,78],[240,76],[245,74],[250,72],[255,70],[260,68],[265,66],[270,64],[275,62],[280,60],[290,50],[300,40],[310,30],[320,20],[330,10]], "é«˜äºŒå¥³": [[202,100],[208,95],[214,90],[221,85],[228,80],[233,78],[238,76],[243,74],[248,72],[253,70],[258,68],[263,66],[268,64],[273,62],[278,60],[288,50],[298,40],[308,30],[318,20],[328,10]], "é«˜ä¸‰å¥³": [[200,100],[206,95],[212,90],[219,85],[226,80],[231,78],[236,76],[241,74],[246,72],[251,70],[256,68],[261,66],[266,64],[271,62],[276,60],[286,50],[296,40],[306,30],[316,20],[326,10]] },
    bonusRule: {
        run: { 
        "ç”·": [4, 8, 12, 16, 20, 23, 26, 29, 32, 35], // 1-10åˆ†å¯¹åº”çš„ç§’æ•°å‡å°‘é‡
        "å¥³": [5, 10, 15, 20, 25, 30, 35, 40, 45, 50]  // 1-10åˆ†å¯¹åº”çš„ç§’æ•°å‡å°‘é‡
    },
    str: { 
        "ç”·": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],         // å¼•ä½“å‘ä¸Šè¶…è¿‡æ¬¡æ•°
        "å¥³": [2, 4, 6, 7, 8, 9, 10, 11, 12, 13]       // ä»°å§èµ·åè¶…è¿‡æ¬¡æ•°
    }
   }
};

// ==========================================
// æ ¸å¿ƒæ•°æ®å˜é‡ä¸å­˜å‚¨é€»è¾‘ (æœ€ç»ˆä¿®å¤ç‰ˆ)
// ==========================================
let GLOBAL_DATA = []; 
let VISION_DATA = []; 
let UNIQUE_CLASSES = []; 
let UNIQUE_CLASSES_V = []; 
let CUR_CLASS_IDX = 0; 
let CUR_CLASS_IDX_V = 0; 
let CUR_VIEW = 'data'; 
let SAVE_TIMER = null; 
let WARN_LIST = []; 
let WARN_PTR = 0;

// ä½¿ç”¨å…¨æ–°çš„å­˜å‚¨Keyï¼Œå¼ºåˆ¶åˆ·æ–°å­˜å‚¨ç©ºé—´ï¼Œè§£å†³ç¼“å­˜å¹²æ‰°
const STORAGE_KEY = 'TiCe_Data_v2025_Fixed'; 
const VISION_STORAGE_KEY = 'TiCe_Vision_Data_v2025_Fixed'; 
const ENV_STORAGE_KEY = 'TiCe_Env_v2025';
const getWorkDate = (startStr, offsetDays) => {
    let date = new Date(startStr);
    let added = 0;
    // 1. å¦‚æœèµ·å§‹æ—¥æ­£å¥½æ˜¯å‘¨æœ«ï¼Œå…ˆç§»åŠ¨åˆ°å‘¨ä¸€
    while (date.getDay() === 0 || date.getDay() === 6) { 
        date.setDate(date.getDate() + 1); 
    }
    // 2. å¢åŠ å¤©æ•° (è·³è¿‡å‘¨æœ«)
    while (added < offsetDays) {
        date.setDate(date.getDate() + 1);
        if (date.getDay() !== 0 && date.getDay() !== 6) { 
            added++; 
        }
    }
    return date; 
};
function saveData() { 
    try { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(GLOBAL_DATA)); 
        localStorage.setItem(VISION_STORAGE_KEY, JSON.stringify(VISION_DATA)); 
    } catch (e) { alert("ä¿å­˜å¤±è´¥ï¼Œå­˜å‚¨ç©ºé—´å¯èƒ½å·²æ»¡ï¼"); console.error(e); } 
}

function debounceSave() { 
    if(SAVE_TIMER) clearTimeout(SAVE_TIMER); 
    SAVE_TIMER = setTimeout(saveData, 500); 
}

// 3. åŠ è½½æ•°æ® (ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶é‡ç®—åˆ†æ•°ï¼Œè§£å†³æŠ¥è¡¨ç©ºç™½é—®é¢˜)
function loadData() {
    // A. è¯»å–ä½“æµ‹æ•°æ®
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
        try {
            GLOBAL_DATA = JSON.parse(raw);
            
            // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šéå†æ‰€æœ‰åŠ è½½çš„æ•°æ®ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—åˆ†æ•°
            // è§£å†³æ—§æ•°æ®ç¼ºå°‘è¯„åˆ†å¯¼è‡´æŠ¥è¡¨é¡µé¢ç©ºç™½çš„é—®é¢˜
            if (Array.isArray(GLOBAL_DATA)) {
                GLOBAL_DATA.forEach((d, i) => {
                    // ç¡®ä¿æ•°æ®å¯¹è±¡å®Œæ•´ï¼Œé˜²æ­¢ç©ºè¡ŒæŠ¥é”™
                    if (d) {
                        GLOBAL_DATA[i] = calculateRowData(d);
                    }
                });
            }
        } catch (e) { 
            console.error("ä½“æµ‹æ•°æ®è§£æå¤±è´¥", e); 
            GLOBAL_DATA = []; 
        }
    }
    
    // B. è¯»å–è§†åŠ›æ•°æ®
    const rawV = localStorage.getItem(VISION_STORAGE_KEY);
    if (rawV) {
        try {
            VISION_DATA = JSON.parse(rawV);
        } catch (e) { 
            console.error("è§†åŠ›æ•°æ®è§£æå¤±è´¥", e); 
            VISION_DATA = []; 
        }
    }

    // C. åˆ·æ–°ç•Œé¢
    if (GLOBAL_DATA.length > 0) {
        updateUniqueClasses();
        // å¦‚æœå½“å‰åœ¨ä½“æµ‹é¡µï¼Œæ¸²æŸ“è¡¨æ ¼
        if(CUR_VIEW === 'data') renderTable();
    }
    
    if (VISION_DATA.length > 0) {
        updateUniqueClassesVision();
        // å¦‚æœå½“å‰åœ¨è§†åŠ›é¡µï¼Œæ¸²æŸ“è¡¨æ ¼
        if(CUR_VIEW === 'vision') renderVisionTable();
    }
}
// æ ¸å¿ƒåŠŸèƒ½ï¼šæ™ºèƒ½åˆå¹¶å¯¼å…¥ï¼ˆå½»åº•è§£å†³â€œå¯¼å…¥åå•ä¸¢å¤±æˆç»©â€é—®é¢˜ï¼‰
function importBasicInfo(e) {
    const f = e.target.files[0];
    const r = new FileReader();
    r.onload = function(ev) {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {header:1}); 
        
        if(json.length < 2) { alert("æ–‡ä»¶å†…å®¹ä¸ºç©º"); return; }
        
        let headerRowIdx = -1;
        for (let i = 0; i < Math.min(json.length, 10); i++) {
            if (!json[i]) continue;
            const rowContent = json[i].join('|');
            if (rowContent.includes('å§“å') || rowContent.includes('å­¦ç±å·') || rowContent.includes('ç­çº§')) {
                headerRowIdx = i; break;
            }
        }
        if (headerRowIdx === -1) { alert("âŒ æœªè¯†åˆ«åˆ°è¡¨å¤´"); return; }
        
        const h = json[headerRowIdx].map(s => String(s || '').trim());
        const findCol = (keywords) => h.findIndex(headerName => keywords.some(k => headerName.includes(k)));
        const col = {
            name: findCol(['å§“å', 'å­¦ç”Ÿå§“å']),
            code: findCol(['å­¦ç±å·']),
            ge: findCol(['æ€§åˆ«']),
            nation: findCol(['æ°‘æ—']), 
            addr: findCol(['å®¶åº­åœ°å€', 'ä½å€']), 
            cls: h.findIndex(headerName => (headerName.includes('ç­çº§') || headerName.includes('åç§°')) && !headerName.includes('ç¼–å·')),
            dob: findCol(['å‡ºç”Ÿæ—¥æœŸ', 'ç”Ÿæ—¥']),
            idCard: findCol(['èº«ä»½è¯', 'è¯ä»¶å·'])
        };

        const fmtDate = (val) => {
            if (!val) return '';
            let y, m, d;
            if (typeof val === 'number' && val > 20000) {
                const date = new Date(Math.round((val - 25569) * 86400 * 1000));
                y = date.getFullYear(); m = date.getMonth() + 1; d = date.getDate();
            } else {
                const s = String(val).trim().replace(/[-.]/g, '/');
                const parts = s.split('/');
                if(parts.length === 3) { y = parseInt(parts[0]); m = parseInt(parts[1]); d = parseInt(parts[2]); } 
                else return '';
            }
            return `${y}/${String(m).padStart(2, '0')}/${String(d).padStart(2, '0')}`;
        };
        const getDobFromId = (val) => {
            if (!val) return '';
            const s = String(val).trim();
            if (s.length === 18) return `${s.substring(6, 10)}/${s.substring(10, 12)}/${s.substring(12, 14)}`;
            if (s.length === 15) return `19${s.substring(6, 8)}/${s.substring(8, 10)}/${s.substring(10, 12)}`;
            return '';
        };

        let addedCount = 0;
        let updatedCount = 0;

        for(let i = headerRowIdx + 1; i < json.length; i++) {
            const row = json[i];
            if(!row) continue;
            const name = row[col.name];
            const className = row[col.cls];
            if(!name || !className) continue;

            const rowCode = col.code > -1 ? String(row[col.code] || '').trim() : '';
            
            let finalDob = '';
            if (col.dob > -1 && row[col.dob]) finalDob = fmtDate(row[col.dob]);
            if ((!finalDob || finalDob === '') && col.idCard > -1 && row[col.idCard]) finalDob = getDobFromId(row[col.idCard]);

            const ids = generateSchoolIds(className);
            const commonInfo = {
                gradeId: ids.gId, classId: ids.cId, gc: className, name: name,
                stuCode: rowCode, ge: col.ge > -1 ? row[col.ge] : '',
                nation: col.nation > -1 ? row[col.nation] : '', 
                addr: col.addr > -1 ? row[col.addr] : '', dob: finalDob
            };

            // 1. åˆå¹¶åˆ°ä½“æµ‹åº“
            let existTice = GLOBAL_DATA.find(d => (d.stuCode && rowCode && d.stuCode == rowCode) || (d.name === name && d.gc === className));
            if(existTice) {
                Object.assign(existTice, commonInfo); // æ›´æ–°ä¿¡æ¯ä½†ä¸æ¸…ç©ºæˆç»©
                updatedCount++;
            } else {
                GLOBAL_DATA.push(calculateRowData({
                    ...commonInfo, h:'', w:'', lung:'', r50:'', sit:'', jump:'', situp:'', pull:'', r1000:'', r800:''
                }));
                addedCount++;
            }

            // 2. åˆå¹¶åˆ°è§†åŠ›åº“
            let existVision = VISION_DATA.find(d => (d.stuCode && rowCode && d.stuCode == rowCode) || (d.name === name && d.gc === className));
            if(existVision) {
                Object.assign(existVision, commonInfo); // æ›´æ–°ä¿¡æ¯ä½†ä¸æ¸…ç©ºè§†åŠ›æ•°æ®
            } else {
                VISION_DATA.push({
                    ...commonInfo, vLL:'', vRL:'', vLS:'', vRS:'', vLC:'', vRC:'', vLA:'', vRA:'', isOk:''
                });
            }
        }
        
        updateUniqueClasses(); updateUniqueClassesVision();
        renderTable(); renderVisionTable(); saveData();
        alert(`âœ… æ™ºèƒ½åˆå¹¶å®Œæˆï¼\nğŸ”¹ æ–°å¢å­¦ç”Ÿï¼š${addedCount} äºº\nğŸ”¸ æ›´æ–°ä¿¡æ¯ï¼š${updatedCount} äºº\nâœ¨ ç°æœ‰æˆç»©å‡å·²ä¿ç•™ã€‚`);
        document.getElementById('infoInput').value = '';
    };
    r.readAsArrayBuffer(f);
}

// ---------------------------
// é€šç”¨é€»è¾‘
// ---------------------------
// ---------------------------
// æ ¸å¿ƒé€»è¾‘å‡½æ•° (ä¿®å¤ç‰ˆï¼šå¢å¼ºåˆä¸­/é«˜ä¸­è¯†åˆ«é€»è¾‘)
// ---------------------------
function getEntryYearInfo(clsName) {
    if (!clsName) return { gId: '', year: '', stage: '', num: '' };
    const now = new Date();
    const curYear = now.getFullYear();
    const curMonth = now.getMonth() + 1;
    // 8æœˆä»¥åç®—æ–°å­¦å¹´
    const academicYear = curMonth >= 8 ? curYear : curYear - 1;

    let stage = '', gradeNum = 0, entryYear = 0;

    // 1. ä¼˜å…ˆå°è¯•æå–æ˜ç¡®çš„å¹´ä»½ (å¦‚ "2023çº§")
    const yearMatch = clsName.match(/(\d{4})çº§/);
    if (yearMatch) {
        entryYear = parseInt(yearMatch[1]);
        gradeNum = academicYear - entryYear + 1;
    }

    // 2. è¯†åˆ«å­¦æ®µ (åˆ/é«˜) å’Œ å¹´çº§ (1/2/3)
    // é€»è¾‘ï¼šå…ˆçœ‹å…³é”®å­—ï¼Œå†çœ‹æ•°å­—ç‰¹å¾
    if (clsName.includes('é«˜') || clsName.includes('èŒ') || clsName.includes('S')) {
        stage = '3'; // é«˜ä¸­é˜¶æ®µ
        if (clsName.includes('é«˜ä¸€') || clsName.includes('10')) gradeNum = 1;
        else if (clsName.includes('é«˜äºŒ') || clsName.includes('11')) gradeNum = 2;
        else if (clsName.includes('é«˜ä¸‰') || clsName.includes('12')) gradeNum = 3;
    } 
    else if (clsName.includes('åˆ') || clsName.includes('ä¸ƒ') || clsName.includes('å…«') || clsName.includes('ä¹') || /^[789]/.test(clsName)) {
        stage = '2'; // åˆä¸­é˜¶æ®µ
        if (clsName.includes('åˆä¸€') || clsName.includes('ä¸ƒ')) gradeNum = 1;
        else if (clsName.includes('åˆäºŒ') || clsName.includes('å…«')) gradeNum = 2;
        else if (clsName.includes('åˆä¸‰') || clsName.includes('ä¹')) gradeNum = 3;
        else {
            // å¤„ç† "705", "801" è¿™ç§çº¯æ•°å­—æ ¼å¼
            const startDigitMatch = clsName.match(/^([789])/);
            if (startDigitMatch) {
                const val = parseInt(startDigitMatch[1]);
                gradeNum = val - 6; // 7->1, 8->2, 9->3
            }
        }
    }

    // 3. æ•°æ®è¡¥å…¨
    // å¦‚æœæ²¡æœ‰å¹´ä»½ä½†æœ‰å¹´çº§ï¼Œåæ¨å¹´ä»½
    if (entryYear === 0 && gradeNum > 0) {
        entryYear = academicYear - (gradeNum - 1);
    }
    // å¦‚æœæœ‰å¹´ä»½ä½†æ²¡æœ‰å¹´çº§ï¼Œè®¡ç®—å¹´çº§
    if (gradeNum <= 0 && entryYear > 0) {
        gradeNum = academicYear - entryYear + 1;
    }

    // 4. æå–ç­å· (n)
    // ç§»é™¤å¹´ä»½éƒ¨åˆ†ï¼Œé¿å… "2023" è¢«è¯¯è¯†åˆ«ä¸ºç­å·
    let textWithoutYear = yearMatch ? clsName.replace(yearMatch[0], '') : clsName;
    let n = 1;
    
    // åŒ¹é…ç­–ç•¥ï¼šä¼˜å…ˆæ‰¾ "xç­"ï¼Œæ‰¾ä¸åˆ°åˆ™æ‰¾æœ«å°¾æ•°å­—
    const classMatch = textWithoutYear.match(/(\d+)(?=[ç­])/); // åŒ¹é… "5ç­" ä¸­çš„ 5
    const endMatch = textWithoutYear.match(/(\d+)$/);          // åŒ¹é… "705" ä¸­çš„ 705
    
    if (classMatch) {
        n = parseInt(classMatch[1]);
    } else if (endMatch) {
        let rawNum = parseInt(endMatch[1]);
        // æ™ºèƒ½é€»è¾‘ï¼šå¦‚æœæ˜¯ 705 ä¸”å¹´çº§æ˜¯ 7ï¼Œåˆ™ç­å·æ˜¯ 5
        if (rawNum > 20) { 
            let sNum = String(rawNum);
            // å–æœ€åä¸¤ä½ä½œä¸ºç­å· (å¦‚ 705 -> 05 -> 5)
            if (sNum.length >= 2) n = parseInt(sNum.substring(sNum.length - 2));
            else n = rawNum;
        } else {
            n = rawNum;
        }
    }

    const numStr = n < 10 ? '0' + n : String(n);
    
    // 5. ç”Ÿæˆç¼–å·
    // è§„åˆ™ï¼šgId = å­¦æ®µ(2/3) + å¹´çº§(1/2/3) -> å¦‚åˆä¸€=21, é«˜ä¸€=31
    let gId = '';
    if (stage && gradeNum > 0) gId = stage + gradeNum;

    return { gId: gId, year: String(entryYear), stage: stage, num: String(n), fullNum: numStr };
}
function generateSchoolIds(clsName) {
    const info = getEntryYearInfo(clsName);
    if (!info.year) return { gId: '', cId: '' };
    return { gId: info.gId, cId: info.year + info.stage + info.fullNum };
}
function getStandardClassName(clsName) {
    if (!clsName) return '';
    if (clsName.includes('çº§')) return clsName;
    const info = getEntryYearInfo(clsName);
    if (!info.year) return clsName;
    return `${info.stage === '2' ? 'åˆä¸­' : 'é«˜ä¸­'}${info.year}çº§${info.num}ç­`;
}
function getSafeKey(grade, gender) { if(!grade) return null; const k = grade + gender; return STDS.lung[k] ? k : null; }
function normalizeGrade(str) {
    if(!str) return ''; const s = String(str);
    const yearMatch = s.match(/(\d{4})çº§/);
    if (yearMatch) {
        const entryYear = parseInt(yearMatch[1]);
        const now = new Date();
        const gradeNum = ((now.getMonth()+1)>=8?now.getFullYear():now.getFullYear()-1) - entryYear + 1;
        if (s.includes('é«˜')) return ['é«˜ä¸€','é«˜äºŒ','é«˜ä¸‰'][gradeNum-1] || '';
        return ['åˆä¸€','åˆäºŒ','åˆä¸‰'][gradeNum-1] || '';
    }
    if(s.includes('é«˜ä¸‰')) return 'é«˜ä¸‰'; if(s.includes('é«˜äºŒ')) return 'é«˜äºŒ'; if(s.includes('é«˜ä¸€')) return 'é«˜ä¸€';
    if(s.includes('åˆä¸‰')||s.includes('ä¹å¹´çº§')) return 'åˆä¸‰'; if(s.includes('åˆäºŒ')||s.includes('å…«å¹´çº§')) return 'åˆäºŒ'; if(s.includes('åˆä¸€')||s.includes('ä¸ƒå¹´çº§')) return 'åˆä¸€';
    return '';
}
function normalizeGender(v) { v = String(v).trim(); return (v === '2' || v.includes('å¥³')) ? 'å¥³' : 'ç”·'; }
function parseTime(v) {
    if (v === 0 || v === '0') return 0;
    if (!v || v === "" || isNaN(v)) return 0;
    
    let s = String(v).trim();
    let val = parseFloat(s);

    // é€»è¾‘ Aï¼šå¤„ç†ç±»ä¼¼ 413 çš„æ•´æ•°æ ¼å¼ (è§†ä¸º 4åˆ†13ç§’)
    if (!s.includes('.') && val >= 100) {
        let m = Math.floor(val / 100);
        let sec = val % 100;
        return m * 60 + sec;
    }
    
    // æ ¸å¿ƒæ–°å¢é€»è¾‘ Bï¼šå¤„ç† 100 ä»¥ä¸‹çš„çº¯æ•´æ•° (å¦‚è¾“å…¥ 4ï¼Œè¯†åˆ«ä¸º 4åˆ†00ç§’)
    if (!s.includes('.') && val < 100) {
        return val * 60; // 4 -> 240ç§’
    }
    
    // é€»è¾‘ Cï¼šå¤„ç†å°æ•°ç‚¹æ ¼å¼ (åŒºåˆ† 4.3 å’Œ 4.03)
    if (s.includes('.')) {
        let parts = s.split('.');
        let m = parseInt(parts[0]) || 0;
        let sStr = parts[1] || '0';
        
        // å¦‚æœå°æ•°ç‚¹ååªæœ‰ä¸€ä½ (å¦‚ 4.3)ï¼Œè¡¥é›¶å˜æˆ 30 ç§’
        if (sStr.length === 1) sStr += '0';
        
        let sec = parseInt(sStr) || 0;
        return m * 60 + sec;
    }
    
    return val > 0 ? val : 0;
}
function secondsToMSS(sec) {
    if (!sec || sec <= 0) return "";
    const m = Math.floor(sec / 60);
    let s = Math.round(sec % 60);
    const sStr = s < 10 ? '0' + s : s;
    // ä½¿ç”¨ toFixed(2) ç¡®ä¿ 4åˆ†æ•´æ˜¾ç¤ºä¸º 4.00 è€Œä¸æ˜¯ 4
    return parseFloat(m + "." + sStr).toFixed(2);
}

// å¯¼å‡ºä¸ŠæŠ¥è¡¨ä¸“ç”¨çš„æ—¶é—´æ ¼å¼ï¼šç¡®ä¿è¾“å…¥ 4 æœ€ç»ˆå¯¼å‡ºä¸º 4â€²00â€³
const fmtTimeExport = (val) => {
    if(!val || val === '' || val === '-') return null;
    
    let totalSec = parseTime(val); // è°ƒç”¨ä¸Šé¢ä¿®æ”¹åçš„ parseTime
    if (totalSec <= 0) return null;

    const m = Math.floor(totalSec / 60);
    const s = Math.round(totalSec % 60);
    const sStr = s < 10 ? '0' + s : s;
    
    return `${m}â€²${sStr}â€³`; 
};
const s2g = (s) => { if(!s && s!==0) return ''; const v=parseFloat(s); return v>=90?'ä¼˜ç§€':(v>=80?'è‰¯å¥½':(v>=60?'åŠæ ¼':'ä¸åŠæ ¼')); };

function calculateRowData(d) {
    const grade = normalizeGrade(d.gc);
    const gender = normalizeGender(d.ge);
    const key = getSafeKey(grade, gender);
    const isMale = gender === 'ç”·';

    if ((!d.gradeId || !d.classId) && d.gc) {
        const ids = generateSchoolIds(d.gc);
        if(!d.gradeId) d.gradeId = ids.gId;
        if(!d.classId) d.classId = ids.cId;
    }

    if (!key) {
        return {
            ...d, grade, gender, isMale,
            res: { bmiS:'-', bmiL:'-', sLung:'-', s50:'-', sSit:'-', sJump:'-', sStr:'-', sRun:'-', bonus:'0', total:'0', g:'æ ‡å‡†ç¼ºå¤±', err: true }
        };
    }

let bmiS = 0, bmiL = '';
if(d.h && d.w && d.h > 0) {
    // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ toFixed(1) å®ç°æ ‡å‡†å››èˆäº”å…¥
    // è¿™æ ·ï¼š16.84 -> 16.8 (ä½ä½“é‡)
    //       16.85 -> 16.9 (æ­£å¸¸)
    //       23.24 -> 23.2 (æ­£å¸¸)
    //       23.25 -> 23.3 (è¶…é‡)
    const bmi = parseFloat((d.w / ((d.h / 100) ** 2)).toFixed(1));
    
    const lim = STDS.bmi[key]; // é«˜äºŒå¥³æ ‡å‡†ä¸º [16.8, 23.2, 25.4]
    if(lim) {
        // åˆ¤å®šé€»è¾‘ç»Ÿä¸€ä½¿ç”¨å››èˆäº”å…¥åçš„ bmi å€¼
        if(bmi <= lim[0]) { 
            bmiL = 'ä½ä½“é‡'; 
            bmiS = 80; 
        } else if(bmi <= lim[1]) { 
            bmiL = 'æ­£å¸¸'; 
            bmiS = 100; 
        } else if(bmi <= lim[2]) { 
            bmiL = 'è¶…é‡'; 
            bmiS = 80; 
        } else { 
            bmiL = 'è‚¥èƒ–'; 
            bmiS = 60; 
        }
    }
}

    const realGetScore = (val, table, mode) => {
        if(val === '' || val === null || val === undefined || isNaN(parseFloat(val))) return 0;
        val = parseFloat(val);
        if(!table) return 0;
        for(let i=0; i<table.length; i++) {
            const [lim, sc] = table[i];
            if((mode===1 && val >= lim) || (mode===-1 && val <= lim)) return sc;
        }
        return 0; 
    };
// ä¿®æ­£ç‰ˆï¼šé€šè¿‡æŸ¥è¡¨æ³•è®¡ç®—éçº¿æ€§é™„åŠ åˆ†
const getBonus = (val, table, ruleArr, mode) => {
    if(!val || !table || !ruleArr || !Array.isArray(ruleArr)) return 0;
    
    // è·å– 100 åˆ†çš„æ ‡å‡†å€¼
    const maxStd = table[0][0];
    
    // è®¡ç®—å½“å‰æˆç»©ä¸æ»¡åˆ†æ ‡å‡†çš„å·®å€¼
    const diff = (mode === 1) ? (val - maxStd) : (maxStd - val);
    
    // å¦‚æœæœªè¾¾åˆ°æ»¡åˆ†æ ‡å‡†ï¼Œé™„åŠ åˆ†ä¸º 0
    if (diff <= 0) return 0;
    
    // ä»é«˜åˆ°ä½åŒ¹é…å¯¹åº”çš„åˆ†å€¼ (10åˆ†åˆ°1åˆ†)
    let points = 0;
    for (let i = ruleArr.length - 1; i >= 0; i--) {
        if (diff >= ruleArr[i]) {
            points = i + 1;
            break;
        }
    }
    return points; 
};

    const sLung = realGetScore(d.lung, STDS.lung[key], 1);
    const s50 = realGetScore(d.r50, STDS.run50[key], -1);
    const sSit = realGetScore(d.sit, STDS.sit[key], 1);
    const sJump = realGetScore(d.jump, STDS.jump[key], 1);

    let sStr=0, sRun=0, bStr=0, bRun=0;
    if(isMale) {
        sStr = realGetScore(d.pull, STDS.str[key], 1);
        if(sStr===100) bStr = getBonus(d.pull, STDS.str[key], STDS.bonusRule.str["ç”·"], 1);
        const tRun = parseTime(d.r1000);
        sRun = tRun > 0 ? realGetScore(tRun, STDS.runL[key], -1) : 0;
        if(sRun===100) bRun = getBonus(tRun, STDS.runL[key], STDS.bonusRule.run["ç”·"], -1);
    } else {
        sStr = realGetScore(d.situp, STDS.str[key], 1);
        if(sStr===100) bStr = getBonus(d.situp, STDS.str[key], STDS.bonusRule.str["å¥³"], 1);
        const tRun = parseTime(d.r800);
        sRun = tRun > 0 ? realGetScore(tRun, STDS.runL[key], -1) : 0;
        if(sRun===100) bRun = getBonus(tRun, STDS.runL[key], STDS.bonusRule.run["å¥³"], -1);
    }

    const W = STDS.weights;
    const baseScore = bmiS*W.bmi + sLung*W.lung + s50*W.run50 + sJump*W.jump + sSit*W.sit + sStr*W.str + sRun*W.runL;
    const bonusScore = Math.min(20, bStr + bRun); 
    const total = (baseScore + bonusScore).toFixed(1);
    let g = 'ä¸åŠæ ¼';
    if(total>=90) g='ä¼˜ç§€'; else if(total>=80) g='è‰¯å¥½'; else if(total>=60) g='åŠæ ¼';

    return { 
        ...d, grade, gender, isMale, 
        res: { bmiS, bmiL, sLung, s50, sSit, sJump, sStr, sRun, bonus: bonusScore, total, g, err: false } 
    };
}

function getClassRank(name) {
    if(!name) return 999999;
    let rank = 0;
    if(name.includes('é«˜')) rank += 2000;
    else if(name.includes('åˆ')) rank += 1000;
    if(name.includes('ä¸‰')) rank += 300;
    else if(name.includes('äºŒ')) rank += 200;
    else if(name.includes('ä¸€')) rank += 100;
    const numMatch = name.match(/\d+/);
    if(numMatch) rank += parseInt(numMatch[0]);
    return rank;
}

function updateUniqueClasses() {
    const classes = new Set(GLOBAL_DATA.map(d => d.gc || 'æœªåˆ†ç±»'));
    UNIQUE_CLASSES = Array.from(classes).sort((a, b) => getClassRank(a) - getClassRank(b));
    if (CUR_CLASS_IDX >= UNIQUE_CLASSES.length) CUR_CLASS_IDX = 0;
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    if (GLOBAL_DATA.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('page-info').innerText = 'æš‚æ— æ•°æ®';
        return;
    }
    updateUniqueClasses();
    const curClass = UNIQUE_CLASSES[CUR_CLASS_IDX];
    const pageData = GLOBAL_DATA.map((d, i) => ({...d, realIdx: i})).filter(d => (d.gc || 'æœªåˆ†ç±»') === curClass);

    document.getElementById('page-info').innerText = `å½“å‰ï¼š${curClass} (${CUR_CLASS_IDX + 1}/${UNIQUE_CLASSES.length} ä¸ªç­çº§)`;

    const html = pageData.map(d => {
        const r = d.res;
        const maleDis = d.isMale ? '' : 'disabled style="background:#f9f9f9"';
        const femDis = !d.isMale ? '' : 'disabled style="background:#f9f9f9"';
        const cls = (sc) => sc>=90?'text-exc':(sc>=80?'text-good':(sc>=60?'text-pass':'text-fail'));
        
        const warnAttr = (field) => {
            if (d.warn && d.warn[field]) {
                return `class="cell-warn" title="${d.warnMsg ? (d.warnMsg[field] || 'å¼‚å¸¸') : 'å¼‚å¸¸'}"`;
            }
            return '';
        };
        
        const runKey = d.isMale ? 'r1000' : 'r800';
        let runClass = '';
        if (d.warn && d.warn[runKey]) runClass = 'cell-warn modified-data'; 
        else if (d.modRun) runClass = 'modified-data';
        
        const runTitle = (d.warn && d.warn[runKey]) ? `title="${d.warnMsg[runKey]}"` : '';
        const runAttr = `class="${runClass}" ${runTitle}`;
        
        let bmiCls = '', gCls = '';
        if (r.bmiL !== '-' && r.bmiL !== '') bmiCls = r.bmiL==='æ­£å¸¸'?'text-bmi-norm':(r.bmiL==='è‚¥èƒ–'?'text-bmi-bad':'text-bmi-warn');
        if (r.err) gCls = 'text-error';
        else gCls = r.g==='ä¼˜ç§€'?'text-exc':(r.g==='è‰¯å¥½'?'text-good':(r.g==='åŠæ ¼'?'text-pass':'text-fail'));
        
        // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ (val === 0 || val) ? val : '' æ¥ç¡®ä¿ 0 èƒ½æ­£å¸¸æ˜¾ç¤º
        const fv = (v) => (v === 0 || v) ? v : '';

        return `<tr data-idx="${d.realIdx}">
            <td><input class="cell-input" data-f="gradeId" value="${fv(d.gradeId)}" placeholder="è‡ªåŠ¨"></td>
            <td><input class="cell-input" data-f="classId" value="${fv(d.classId)}" placeholder="è‡ªåŠ¨"></td>
            <td><input class="cell-input" data-f="gc" value="${fv(d.gc)}"></td>
            <td><input class="cell-input" data-f="stuCode" value="${fv(d.stuCode)}"></td>
            <td><input class="cell-input" data-f="nation" value="${fv(d.nation)}"></td>
            <td><input class="cell-input" data-f="name" value="${fv(d.name)}"></td>
            <td><input class="cell-input" data-f="ge" value="${fv(d.ge)}"></td>
            <td><input class="cell-input" data-f="dob" value="${fv(d.dob)}"></td>
            <td><input class="cell-input" data-f="addr" value="${fv(d.addr)}"></td>

            <td ${warnAttr('h')}><input class="cell-input" type="number" data-f="h" value="${fv(d.h)}"></td>
            <td ${warnAttr('w')}><input class="cell-input" type="number" data-f="w" value="${fv(d.w)}"></td>
            <td ${warnAttr('lung')} class="${d.modLung?'modified-data':''}"><input class="cell-input" type="number" data-f="lung" value="${fv(d.lung)}"></td>
            <td ${warnAttr('r50')} class="${d.mod50?'modified-data':''}"><input class="cell-input" type="number" data-f="r50" value="${fv(d.r50)}"></td>
            <td ${warnAttr('sit')}><input class="cell-input" type="number" data-f="sit" value="${fv(d.sit)}"></td>
            <td ${warnAttr('situp')}><input class="cell-input" type="number" data-f="situp" value="${fv(d.situp)}" ${femDis}></td>
            <td ${warnAttr('jump')} class="${d.modJump?'modified-data':''}"><input class="cell-input" type="number" data-f="jump" value="${fv(d.jump)}"></td>
            <td ${warnAttr('pull')}><input class="cell-input" type="number" data-f="pull" value="${fv(d.pull)}" ${maleDis}></td>
            <td ${d.isMale?runAttr:''}><input class="cell-input" type="number" data-f="r1000" value="${fv(d.r1000)}" ${maleDis}></td>
            <td ${!d.isMale?runAttr:''}><input class="cell-input" type="number" data-f="r800" value="${fv(d.r800)}" ${femDis}></td>
            
            <td class="calc-cell bg-header-score">${fv(r.bmiS)}</td>
            <td class="bg-header-score ${bmiCls}">${fv(r.bmiL)}</td>
            <td class="calc-cell bg-header-score">${fv(r.sLung)}</td>
            <td class="bg-header-score ${cls(r.sLung)}">${s2g(r.sLung)}</td>
            <td class="calc-cell bg-header-score">${fv(r.s50)}</td>
            <td class="bg-header-score ${cls(r.s50)}">${s2g(r.s50)}</td>
            <td class="calc-cell bg-header-score">${fv(r.sJump)}</td>
            <td class="bg-header-score ${cls(r.sJump)}">${s2g(r.sJump)}</td>
            <td class="calc-cell bg-header-score">${fv(r.sSit)}</td>
            <td class="bg-header-score ${cls(r.sSit)}">${s2g(r.sSit)}</td>
            <td class="calc-cell bg-header-score">${d.isMale?'-':fv(r.sRun)}</td>
            <td class="bg-header-score ${!d.isMale?cls(r.sRun):''}">${d.isMale?'':s2g(r.sRun)}</td>
            <td class="calc-cell bg-header-score">${d.isMale?fv(r.sRun):'-'}</td>
            <td class="bg-header-score ${d.isMale?cls(r.sRun):''}">${d.isMale?s2g(r.sRun):''}</td>
            <td class="calc-cell bg-header-score">${d.isMale?'-':fv(r.sStr)}</td>
            <td class="bg-header-score ${!d.isMale?cls(r.sStr):''}">${d.isMale?'':s2g(r.sStr)}</td>
            <td class="calc-cell bg-header-score">${d.isMale?fv(r.sStr):'-'}</td>
            <td class="bg-header-score ${d.isMale?cls(r.sStr):''}">${d.isMale?s2g(r.sStr):''}</td>
            <td class="bg-header-score">${fv(r.bonus)}</td>
            <td class="text-total bg-header-score">${fv(r.total)}</td>
            <td class="bg-header-score ${gCls}">${fv(r.g)}</td>
            <td><button class="btn btn-red" onclick="delRow(${d.realIdx})" style="padding:2px 6px">Ã—</button></td>
        </tr>`;
    }).join('');
    tbody.innerHTML = html;
}
function updateUniqueClasses() { UNIQUE_CLASSES = Array.from(new Set(GLOBAL_DATA.map(d => d.gc || 'æœªåˆ†ç±»'))).sort((a, b) => getClassRank(a) - getClassRank(b)); if (CUR_CLASS_IDX >= UNIQUE_CLASSES.length) CUR_CLASS_IDX = 0; }
function updateUniqueClassesVision() { UNIQUE_CLASSES_V = Array.from(new Set(VISION_DATA.map(d => d.gc || 'æœªåˆ†ç±»'))).sort((a, b) => getClassRank(a) - getClassRank(b)); if (CUR_CLASS_IDX_V >= UNIQUE_CLASSES_V.length) CUR_CLASS_IDX_V = 0; }
function renderVisionTable() {
    const tbody = document.getElementById('visionTableBody');
    if (VISION_DATA.length === 0) { tbody.innerHTML = ''; if(CUR_VIEW === 'vision') document.getElementById('page-info').innerText = 'æš‚æ— è§†åŠ›æ•°æ®'; return; }
    updateUniqueClassesVision(); const curClass = UNIQUE_CLASSES_V[CUR_CLASS_IDX_V];
    const pageData = VISION_DATA.map((d, i) => ({...d, realIdx: i})).filter(d => (d.gc || 'æœªåˆ†ç±»') === curClass);
    if(CUR_VIEW === 'vision') document.getElementById('page-info').innerText = `è§†åŠ›ï¼š${curClass} (${CUR_CLASS_IDX_V + 1}/${UNIQUE_CLASSES_V.length})`;
    const fv = (v) => (v === 0 || v) ? v : '';
    tbody.innerHTML = pageData.map(d => {
        return `<tr data-idx="${d.realIdx}">
            <td><input class="cell-input" readonly value="${fv(d.gradeId)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.classId)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.gc)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.stuCode)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.nation)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.name)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.ge)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.dob)}"></td>
            <td><input class="cell-input" readonly value="${fv(d.addr)}"></td>
            <td style="background:#fcf7ff"><input class="cell-input" data-f="vRL" value="${fv(d.vRL)}"></td>
            <td style="background:#fcf7ff"><input class="cell-input" data-f="vLL" value="${fv(d.vLL)}"></td>
            <td><input class="cell-input" data-f="vRS" value="${fv(d.vRS)}"></td> <td><input class="cell-input" data-f="vRC" value="${fv(d.vRC)}"></td> <td><input class="cell-input" data-f="vRA" value="${fv(d.vRA)}"></td>
            <td><input class="cell-input" data-f="vLS" value="${fv(d.vLS)}"></td> <td><input class="cell-input" data-f="vLC" value="${fv(d.vLC)}"></td> <td><input class="cell-input" data-f="vLA" value="${fv(d.vLA)}"></td>
            <td><input class="cell-input" data-f="isOk" value="${fv(d.isOk)}"></td>
            <td><button class="btn btn-red" onclick="delRow(${d.realIdx}, 'vision')" style="padding:2px 6px">Ã—</button></td>
        </tr>`;
    }).join('');
}

function importExcel(e) {
    const f = e.target.files[0]; const r = new FileReader();
    r.onload = function(ev) {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'}); let matchCount = 0;
        wb.SheetNames.forEach(sheetName => {
            const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header:1}); if(json.length < 2) return; 
            let headerRowIdx = -1;
            for (let i = 0; i < Math.min(json.length, 10); i++) if (json[i] && json[i].join('|').match(/å§“å|èº«é«˜|ç­çº§/)) { headerRowIdx = i; break; }
            if (headerRowIdx === -1) return; 
            const h = json[headerRowIdx].map(s => String(s || '').trim());
            const findCol = (kws) => h.findIndex(n => kws.some(k => n.includes(k)));
            const col = { gc: findCol(['ç­çº§']), na: findCol(['å§“å']), code: findCol(['å­¦ç±å·']), ht: findCol(['èº«é«˜']), wt: findCol(['ä½“é‡']), lu: findCol(['è‚ºæ´»é‡']), r50: findCol(['50ç±³']), st: findCol(['åä½']), jp: findCol(['è·³è¿œ']), strM: findCol(['å¼•ä½“']), strF: findCol(['ä»°å§']), runM: findCol(['1000']), runF: findCol(['800']) };
            for(let i = headerRowIdx + 1; i < json.length; i++) {
                const r = json[i]; if(!r) continue;
                const rowCls = col.gc > -1 ? r[col.gc] : ''; const rowName = col.na > -1 ? r[col.na] : '';
                const student = GLOBAL_DATA.find(d => (col.code>-1 && r[col.code] && d.stuCode == r[col.code]) || (d.gc === rowCls && d.name === rowName));
                if (student) {
                    if(col.ht>-1) student.h=r[col.ht]; if(col.wt>-1) student.w=r[col.wt]; if(col.lu>-1) student.lung=r[col.lu];
                    if(col.r50>-1) student.r50=r[col.r50]; if(col.st>-1) student.sit=r[col.st]; if(col.jp>-1) student.jump=r[col.jp];
                    if(col.strF>-1) student.situp=r[col.strF]; if(col.strM>-1) student.pull=r[col.strM];
                    if(col.runM>-1) student.r1000=r[col.runM]; if(col.runF>-1) student.r800=r[col.runF];
                    Object.assign(student, calculateRowData(student)); matchCount++;
                }
            }
        });
        updateUniqueClasses(); renderTable(); saveData(); alert(`âœ… æˆç»©å¯¼å…¥å®Œæˆï¼æ›´æ–° ${matchCount} äººã€‚`);
        document.getElementById('fileInput').value = '';
    }; r.readAsArrayBuffer(f);
}

// ğŸ‘ï¸ è§†åŠ›æˆç»©å¯¼å…¥ï¼šä¿®å¤ç‰ˆ (é€‚é…æ‚¨çš„Excelæ ¼å¼ + æ­£ç¡®å†™å…¥è§†åŠ›åº“)
function importVisionExcel(e) {
    const f = e.target.files[0];
    const r = new FileReader();
    r.onload = function(ev) {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
        let matchCount = 0;
        let sheetCount = 0;

        // éå†æ‰€æœ‰å·¥ä½œè¡¨
        wb.SheetNames.forEach(sheetName => {
            const json = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header:1});
            if(json.length < 2) return; 

            // 1. æ™ºèƒ½å®šä½è¡¨å¤´è¡Œï¼ˆå‰10è¡Œå†…æœç´¢å…³é”®å­—ï¼‰
            let headerRowIdx = -1;
            for (let i = 0; i < Math.min(json.length, 10); i++) {
                if (!json[i] || json[i].length === 0) continue;
                const rowContent = json[i].join('|');
                // æ ¹æ®æ‚¨çš„æˆªå›¾ï¼Œè¡¨å¤´åŒ…å« "å·¦çœ¼" æˆ– "å±ˆå…‰åº¦"
                if (rowContent.includes('å­¦ç±å·') || rowContent.includes('å§“å') || rowContent.includes('å·¦çœ¼') || rowContent.includes('å±ˆå…‰åº¦')) {
                    headerRowIdx = i;
                    break;
                }
            }

            if (headerRowIdx === -1) return; 
            sheetCount++;

            const h = json[headerRowIdx].map(s => String(s || '').trim());
            const findCol = (kws) => h.findIndex(n => kws.some(k => n.includes(k)));

            // 2. æ˜ å°„åˆ—ç´¢å¼• (ä¸¥æ ¼é€‚é…æ‚¨çš„Excelæˆªå›¾)
            const col = {
                code: findCol(['å­¦ç±å·']),
                name: findCol(['å§“å']),
                
                // è£¸çœ¼è§†åŠ› (æˆªå›¾å¯¹åº”ï¼šå·¦çœ¼ã€å³çœ¼)
                vRL: findCol(['å³çœ¼', 'å³è£¸çœ¼']), 
                vLL: findCol(['å·¦çœ¼', 'å·¦è£¸çœ¼']),
                
                // å±ˆå…‰åº¦ (æˆªå›¾å¯¹åº”ï¼šå±ˆå…‰åº¦å·¦Sã€å±ˆå…‰åº¦å·¦Cã€å±ˆå…‰åº¦å·¦A ç­‰)
                vLS: findCol(['å±ˆå…‰åº¦å·¦S', 'å·¦çƒé•œ', 'å·¦S']), 
                vLC: findCol(['å±ˆå…‰åº¦å·¦C', 'å·¦æŸ±é•œ', 'å·¦C']), 
                vLA: findCol(['å±ˆå…‰åº¦å·¦A', 'å·¦è½´ä½', 'å·¦A']),
                
                vRS: findCol(['å±ˆå…‰åº¦å³S', 'å³çƒé•œ', 'å³S']), 
                vRC: findCol(['å±ˆå…‰åº¦å³C', 'å³æŸ±é•œ', 'å³C']), 
                vRA: findCol(['å±ˆå…‰åº¦å³A', 'å³è½´ä½', 'å³A']),
                
                isOk: findCol(['OKé•œ', 'è§’è†œå¡‘å½¢é•œ'])
            };

            // 3. å¤„ç†æ•°æ®
            for(let i = headerRowIdx + 1; i < json.length; i++) {
                const row = json[i];
                if(!row) continue;

                const rowCode = col.code > -1 ? String(row[col.code] || '').trim() : '';
                const rowName = col.name > -1 ? String(row[col.name] || '').trim() : '';
                
                // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå¿…é¡»åœ¨ VISION_DATA ä¸­æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯ GLOBAL_DATA
                let stu = VISION_DATA.find(d => {
                    const dCode = String(d.stuCode || '').trim();
                    const dName = String(d.name || '').trim();
                    // ä¼˜å…ˆåŒ¹é…å­¦ç±å·ï¼Œå…¶æ¬¡åŒ¹é…å§“å
                    if (rowCode && dCode === rowCode) return true; 
                    if (!rowCode && rowName && dName === rowName) return true; 
                    return false;
                });

                if (stu) {
                    // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šå­—æ®µåå¿…é¡»ä¸ renderVisionTable ä¸­çš„ä¸€è‡´ (vRL, vLL...)
                    if(col.vRL > -1) stu.vRL = row[col.vRL] || '';
                    if(col.vLL > -1) stu.vLL = row[col.vLL] || '';
                    
                    if(col.vRS > -1) stu.vRS = row[col.vRS] || '';
                    if(col.vRC > -1) stu.vRC = row[col.vRC] || '';
                    if(col.vRA > -1) stu.vRA = row[col.vRA] || '';
                    
                    if(col.vLS > -1) stu.vLS = row[col.vLS] || '';
                    if(col.vLC > -1) stu.vLC = row[col.vLC] || '';
                    if(col.vLA > -1) stu.vLA = row[col.vLA] || '';
                    
                    if(col.isOk > -1) stu.isOk = (String(row[col.isOk] || '').includes('æ˜¯')) ? 'æ˜¯' : 'å¦';
                    
                    matchCount++;
                }
            }
        });

        if (sheetCount === 0) {
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„è§†åŠ›è¡¨å¤´ã€‚è¯·ç¡®ä¿ExcelåŒ…å«ï¼šå­¦ç±å·/å§“åã€å·¦çœ¼/å³çœ¼ã€å±ˆå…‰åº¦ç­‰åˆ—ã€‚');
        } else {
            updateUniqueClassesVision();
            if (CUR_VIEW === 'vision') renderVisionTable();
            saveData();
            alert(`âœ… è§†åŠ›æ•°æ®å¯¼å…¥å®Œæˆï¼\nğŸ“Š æ‰«æå·¥ä½œè¡¨ï¼š${sheetCount} ä¸ª\nğŸ”— æˆåŠŸåŒ¹é…æ›´æ–°ï¼š${matchCount} äºº`);
        }
        document.getElementById('visionInput').value = '';
    };
    r.readAsArrayBuffer(f);
}
// ğŸ†• å¯¼å‡ºè§†åŠ›æ•°æ® (ä¿®å¤ç‰ˆï¼šä¿®æ­£å˜é‡å + åŒ¹é…æˆªå›¾è¡¨å¤´)
function exportVisionData() {
    // 1. æ£€æŸ¥æ•°æ®æº (ä¿®æ­£å˜é‡åä¸º VISION_DATA)
    if(!VISION_DATA || !VISION_DATA.length) { 
        alert("æ— è§†åŠ›æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥æˆ–å½•å…¥ï¼"); 
        return; 
    }
    
    // 2. æ°‘æ—ä»£ç æ˜ å°„è¡¨ (ç¡®ä¿è¾“å‡ºä¸å¸¦å‰å¯¼é›¶çš„æ•°å­—å­—ç¬¦ä¸²)
    const NATION_MAP = { 
        "æ±‰æ—": "1", "è’™å¤æ—": "2", "å›æ—": "3", "è—æ—": "4", "ç»´å¾å°”æ—": "5", "è‹—æ—": "6", "å½æ—": "7", "å£®æ—": "8", "å¸ƒä¾æ—": "9", "æœé²œæ—": "10", "æ»¡æ—": "11", "ä¾—æ—": "12", "ç‘¶æ—": "13", "ç™½æ—": "14", "åœŸå®¶æ—": "15", "å“ˆå°¼æ—": "16", "å“ˆè¨å…‹æ—": "17", "å‚£æ—": "18", "é»æ—": "19", "å‚ˆåƒ³æ—": "20", "ä½¤æ—": "21", "ç•²æ—": "22", "é«˜å±±æ—": "23", "æ‹‰ç¥œæ—": "24", "æ°´æ—": "25", "ä¸œä¹¡æ—": "26", "çº³è¥¿æ—": "27", "æ™¯é¢‡æ—": "28", "æŸ¯å°”å…‹å­œæ—": "29", "åœŸæ—": "30", "è¾¾æ–¡å°”æ—": "31", "ä»«ä½¬æ—": "32", "ç¾Œæ—": "33", "å¸ƒæœ—æ—": "34", "æ’’æ‹‰æ—": "35", "æ¯›å—æ—": "36", "ä»¡ä½¬æ—": "37", "é”¡ä¼¯æ—": "38", "é˜¿æ˜Œæ—": "39", "æ™®ç±³æ—": "40", "å¡”å‰å…‹æ—": "41", "æ€’æ—": "42", "ä¹Œå­œåˆ«å…‹æ—": "43", "ä¿„ç½—æ–¯æ—": "44", "é„‚æ¸©å…‹æ—": "45", "å¾·æ˜‚æ—": "46", "ä¿å®‰æ—": "47", "è£•å›ºæ—": "48", "äº¬æ—": "49", "å¡”å¡”å°”æ—": "50", "ç‹¬é¾™æ—": "51", "é„‚ä¼¦æ˜¥æ—": "52", "èµ«å“²æ—": "53", "é—¨å·´æ—": "54", "çå·´æ—": "55", "åŸºè¯ºæ—": "56", "å…¶ä»–": "57", "å¤–å›½è¡€ç»Ÿ": "58" 
    };

    const fmtNation = (val) => {
        if(!val && val !== 0) return '';
        const s = String(val).trim();
        // è‡ªåŠ¨å‰¥ç¦»æ•°å­—å‰å¯¼é›¶ (å¦‚ "01" -> "1")
        if (/^\d+$/.test(s)) return String(parseInt(s, 10));
        return NATION_MAP[s] || s;
    };

    const wb = XLSX.utils.book_new();
    
    // 3. å®šä¹‰è¡¨å¤´ (ä¸¥æ ¼å¯¹ç…§æ‚¨çš„æˆªå›¾)
    const header = [
        "å¹´çº§ç¼–å·", "ç­çº§ç¼–å·", "ç­çº§åç§°", "å­¦ç±å·", "æ°‘æ—ä»£ç ", 
        "å§“å", "æ€§åˆ«", "å‡ºç”Ÿæ—¥æœŸ", "å®¶åº­ä½å€",
        "å³çœ¼è£¸çœ¼è§†åŠ›", "å·¦çœ¼è£¸çœ¼è§†åŠ›", 
        "å³çœ¼å±ˆå…‰çƒé•œ", "å³çœ¼å±ˆå…‰æŸ±é•œ", "å³çœ¼å±ˆå…‰è½´ä½", 
        "å·¦çœ¼å±ˆå…‰çƒé•œ", "å·¦çœ¼å±ˆå…‰æŸ±é•œ", "å·¦çœ¼å±ˆå…‰è½´ä½", 
        "æ˜¯å¦ä¸ºè§’è†œå¡‘å½¢é•œï¼ˆOKé•œï¼‰"
    ];

    // 4. ç”Ÿæˆæ•°æ®ä½“ (ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå vRL, vRS ç­‰)
    const body = VISION_DATA.map(d => {
        const genderRaw = String(d.ge || '').trim();
        // è‡ªåŠ¨è½¬æ¢æ€§åˆ«ä¸ºä»£ç ï¼šç”·=1ï¼Œå¥³=2
        const genderCode = (genderRaw === 'ç”·' || genderRaw === '1') ? 1 : 2;
        
        return [
            d.gradeId || '', 
            d.classId || '', 
            getStandardClassName(d.gc) || d.gc, 
            d.stuCode || '', 
            fmtNation(d.nation), 
            d.name || '',
            genderCode,
            d.dob || '', 
            d.addr || '',
            // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„ç®€å†™å­—æ®µåï¼Œä¸é¡µé¢æ˜¾ç¤ºä¿æŒä¸€è‡´
            d.vRL || '', d.vLL || '', 
            d.vRS || '', d.vRC || '', d.vRA || '',
            d.vLS || '', d.vLC || '', d.vLA || '',
            d.isOk || 'å¦'
        ];
    });

    const ws = XLSX.utils.aoa_to_sheet([header, ...body]);
    
    // 5. è®¾ç½®åˆ—å®½ (ç¾åŒ–è¾“å‡º)
    ws['!cols'] = [
        { wch: 8 }, { wch: 12 }, { wch: 20 }, { wch: 18 }, { wch: 8 }, 
        { wch: 10 }, { wch: 6 }, { wch: 12 }, { wch: 25 },
        { wch: 12 }, { wch: 12 }, 
        { wch: 12 }, { wch: 12 }, { wch: 12 },
        { wch: 12 }, { wch: 12 }, { wch: 12 }, 
        { wch: 25 }
    ];

    XLSX.utils.book_append_sheet(wb, ws, "è§†åŠ›ä¸ŠæŠ¥æ•°æ®");
    XLSX.writeFile(wb, `å…¨æ ¡å­¦ç”Ÿè§†åŠ›ä¸ŠæŠ¥è¡¨_${new Date().toLocaleDateString()}.xlsx`);
}

function deleteEmptyRows() {
    // A. ä½“æµ‹é¡µé¢é€»è¾‘
    if (CUR_VIEW === 'data') {
        if (!GLOBAL_DATA.length) { alert("ä½“æµ‹æš‚æ— æ•°æ®ã€‚"); return; }
        const oldLen = GLOBAL_DATA.length;
        const noCodeRows = GLOBAL_DATA.filter(d => !d.stuCode || String(d.stuCode).trim() === '');
        
        if (noCodeRows.length > 0) {
            if (!confirm(`ğŸƒ ä½“æµ‹åº“ï¼šå‘ç° ${noCodeRows.length} æ¡æ— å­¦ç±è®°å½•ã€‚ç«‹å³æ¸…ç†ï¼Ÿ`)) return;
            GLOBAL_DATA = GLOBAL_DATA.filter(d => d.stuCode && String(d.stuCode).trim() !== '');
        } else {
             const scoreFields = ['h', 'w', 'lung', 'r50', 'sit', 'situp', 'jump', 'pull', 'r1000', 'r800'];
             const noScoreRows = GLOBAL_DATA.filter(d => scoreFields.every(field => !d[field]));
             if (noScoreRows.length > 0) {
                 if (!confirm(`ğŸƒ ä½“æµ‹åº“ï¼šå‘ç° ${noScoreRows.length} æ¡æˆç»©å…¨ç©ºè®°å½•ã€‚ç«‹å³æ¸…ç†ï¼Ÿ`)) return;
                 GLOBAL_DATA = GLOBAL_DATA.filter(d => !scoreFields.every(field => !d[field]));
             } else {
                 alert("âœ¨ ä½“æµ‹åº“æ•°æ®å®Œæ•´ã€‚"); return;
             }
        }
        updateUniqueClasses(); CUR_CLASS_IDX = 0; renderTable(); saveData();
    } 
    // B. è§†åŠ›é¡µé¢é€»è¾‘
    else if (CUR_VIEW === 'vision') {
        if (!VISION_DATA.length) { alert("è§†åŠ›æš‚æ— æ•°æ®ã€‚"); return; }
        const oldLen = VISION_DATA.length;
        const noCodeRows = VISION_DATA.filter(d => !d.stuCode || String(d.stuCode).trim() === '');
        
        if (noCodeRows.length > 0) {
            if (!confirm(`ğŸ‘ï¸ è§†åŠ›åº“ï¼šç¬¬ä¸€æ­¥ - å‘ç° ${noCodeRows.length} æ¡æ— å­¦ç±è®°å½•ã€‚ç«‹å³æ¸…ç†ï¼Ÿ`)) return;
            VISION_DATA = VISION_DATA.filter(d => d.stuCode && String(d.stuCode).trim() !== '');
            saveData();
            updateUniqueClassesVision(); renderVisionTable();
            // é€’å½’è°ƒç”¨è¿›è¡Œç¬¬äºŒæ­¥æ£€æŸ¥
            setTimeout(deleteEmptyRows, 100); 
            return;
        } 
        
        // è§†åŠ›å­—æ®µæ£€æµ‹
        const vFields = ['vLL','vRL','vLS','vRS'];
        const noVisionRows = VISION_DATA.filter(d => vFields.every(f => !d[f]));
        
        if (noVisionRows.length > 0) {
            if (!confirm(`ğŸ‘ï¸ è§†åŠ›åº“ï¼šç¬¬äºŒæ­¥ - å‘ç° ${noVisionRows.length} æ¡æ— è§†åŠ›æ•°æ®è®°å½•ã€‚ç«‹å³æ¸…ç†ï¼Ÿ`)) return;
            VISION_DATA = VISION_DATA.filter(d => !vFields.every(f => !d[f]));
        } else {
            alert("âœ¨ è§†åŠ›åº“æ•°æ®å®Œæ•´ã€‚"); return;
        }
        updateUniqueClassesVision(); CUR_CLASS_IDX_V = 0; renderVisionTable(); saveData();
    }
}
function deleteCurrentClass() {
    if (CUR_VIEW === 'data') {
        if (!UNIQUE_CLASSES.length) return;
        const cls = UNIQUE_CLASSES[CUR_CLASS_IDX];
        if (!confirm(`âš ï¸ ç¡®å®šåˆ é™¤ä½“æµ‹åº“ä¸­ã€${cls}ã€‘çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) return;
        GLOBAL_DATA = GLOBAL_DATA.filter(d => d.gc !== cls);
        updateUniqueClasses(); CUR_CLASS_IDX = 0; renderTable();
    } else if (CUR_VIEW === 'vision') {
        if (!UNIQUE_CLASSES_V.length) return;
        const cls = UNIQUE_CLASSES_V[CUR_CLASS_IDX_V];
        if (!confirm(`âš ï¸ ç¡®å®šåˆ é™¤è§†åŠ›åº“ä¸­ã€${cls}ã€‘çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) return;
        VISION_DATA = VISION_DATA.filter(d => d.gc !== cls);
        updateUniqueClassesVision(); CUR_CLASS_IDX_V = 0; renderVisionTable();
    }
    saveData();
}

function clearTable() {
    if (CUR_VIEW === 'data') {
        if(confirm('ğŸ’¥ ç¡®å®šæ¸…ç©ºæ‰€æœ‰ã€ä½“æµ‹æ•°æ®ã€‘å—ï¼Ÿ(ä¸å½±å“è§†åŠ›æ•°æ®)')) { GLOBAL_DATA = []; updateUniqueClasses(); renderTable(); }
    } else if (CUR_VIEW === 'vision') {
        if(confirm('ğŸ’¥ ç¡®å®šæ¸…ç©ºæ‰€æœ‰ã€è§†åŠ›æ•°æ®ã€‘å—ï¼Ÿ(ä¸å½±å“ä½“æµ‹æ•°æ®)')) { VISION_DATA = []; updateUniqueClassesVision(); renderVisionTable(); }
    }
    saveData();
}
function changeClass(delta) {
    if (CUR_VIEW === 'data' || CUR_VIEW === 'report') {
        if (UNIQUE_CLASSES.length === 0) return;
        CUR_CLASS_IDX += delta;
        if (CUR_CLASS_IDX < 0) CUR_CLASS_IDX = UNIQUE_CLASSES.length - 1;
        if (CUR_CLASS_IDX >= UNIQUE_CLASSES.length) CUR_CLASS_IDX = 0;
        renderTable();
    } else if (CUR_VIEW === 'vision') {
        if (UNIQUE_CLASSES_V.length === 0) return;
        CUR_CLASS_IDX_V += delta;
        if (CUR_CLASS_IDX_V < 0) CUR_CLASS_IDX_V = UNIQUE_CLASSES_V.length - 1;
        if (CUR_CLASS_IDX_V >= UNIQUE_CLASSES_V.length) CUR_CLASS_IDX_V = 0;
        renderVisionTable();
    }
}
function switchView(v) {
    CUR_VIEW = v;
    // 1. å¤„ç† Tab æ ·å¼
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active', 'active-vision'));
    const activeTab = document.getElementById('tab-' + v);
    if (activeTab) {
        activeTab.classList.add('active');
        if (v === 'vision') activeTab.classList.add('active-vision');
    }

    // 2. åˆ‡æ¢ä¸»è§†å›¾æ˜¾ç¤º/éšè—
    ['data', 'report', 'vision'].forEach(viewName => {
        const el = document.getElementById('view-' + viewName);
        if (el) el.classList.toggle('hidden', viewName !== v);
    });
    
    // 3. åŠ¨æ€æ§åˆ¶å·¥å…·æ æŒ‰é’®ç»„
    const ticeGroup = document.getElementById('group-tice');
    const visionGroup = document.getElementById('group-vision');
    if (ticeGroup) ticeGroup.style.display = (v === 'vision' ? 'none' : 'flex');
    if (visionGroup) visionGroup.style.display = (v === 'vision' ? 'flex' : 'none');

    // 4. æ ¸å¿ƒä¿®å¤ï¼šåˆ‡æ¢åˆ°ä¸åŒé¡µé¢æ—¶çš„åˆå§‹åŒ–è¡Œä¸º
    if (v === 'vision') {
        renderVisionTable(); 
    } else if (v === 'report') {
        // å…³é”®ï¼šåˆ‡æ¢åˆ°æŠ¥å‘Šé¡µå¿…é¡»è°ƒç”¨ç”Ÿæˆå‡½æ•°ï¼Œå¦åˆ™é¡µé¢ä¸ºç©º
        genReport(); 
    } else {
        renderTable(); 
    }
}
function delRow(idx, type) {
    if(!confirm('åˆ ï¼Ÿ')) return;
    if(type==='data') { GLOBAL_DATA.splice(idx,1); renderTable(); }
    if(type==='vision') { VISION_DATA.splice(idx,1); renderVisionTable(); }
    saveData();
}
// æ™ºèƒ½çº é”™ä¸å®šä½åŠŸèƒ½ (å…¨åŠŸèƒ½åˆå¹¶ç‰ˆï¼šå«èŒƒå›´æ£€æµ‹ã€0å€¼æ£€æµ‹ã€60è¿›åˆ¶ä¿®å¤)
// ---------------------------
function runSmartCheck() {
    let fixCount = 0;
    WARN_LIST = []; 
    
    const cleanUnit = (val) => {
        if(val === 0 || val === '0') return 0;
        if(!val) return val;
        let s = String(val).trim().replace(/['"â€â€™â€˜ï¼š:ï¼Œ,]/g, '.');
        s = s.replace(/[^\d.-]/g, '');
        return s === '' ? val : parseFloat(s);
    };

    GLOBAL_DATA.forEach((d, i) => {
        let modified = false;
        
        // 1. åŸºç¡€æ•°æ®é¢„æ¸…æ´—
        ['h','w','lung','r50','sit','jump','situp','pull','r1000','r800'].forEach(k => {
            const clean = cleanUnit(d[k]);
            if(clean !== d[k]) { d[k] = clean; modified = true; }
        });

        // 2. é•¿è·‘æ ¼å¼ä¸è¿›ä½è‡ªåŠ¨ä¿®æ­£ (å¤„ç†å¦‚ 413 -> 4.13 ä»¥åŠ 3.69 -> 4.09)
        const runKey = d.isMale ? 'r1000' : 'r800';
        let rVal = d[runKey];
        if (rVal) {
            let sVal = String(rVal);
            // è‡ªåŠ¨ä¿®æ­£ï¼šå¦‚æœæ˜¯ 413 è¿™ç§æ•´æ•°æ ¼å¼ï¼Œæˆ–è€…ç§’æ•°éƒ¨åˆ† >= 60
            if ((!sVal.includes('.') && parseFloat(rVal) >= 100) || 
                (sVal.includes('.') && parseInt(sVal.split('.')[1]) >= 60)) {
                let totalSeconds = parseTime(rVal);
                d[runKey] = secondsToMSS(totalSeconds);
                modified = true;
            }
        }

        // 3. å…¶ä»–å¸¸è§„è‡ªåŠ¨åŒ–ä¿®æ­£ (æ€§åˆ«å½’ä½ã€èº«é«˜/è·³è¿œç¼©æ”¾)
        const fixGenderMismatch = (cK, wK) => {
            if (!d[cK] && d[wK]) { d[cK] = d[wK]; d[wK] = ''; modified = true; }
            else if (d[cK] && d[wK]) { d[wK] = ''; modified = true; }
        };
        if (d.isMale) { fixGenderMismatch('r1000', 'r800'); fixGenderMismatch('pull', 'situp'); }
        else { fixGenderMismatch('r800', 'r1000'); fixGenderMismatch('situp', 'pull'); }

        // å•ä½çº é”™é€»è¾‘ï¼šå¦‚èº«é«˜å¡«äº† 1.75 è‡ªåŠ¨è½¬ä¸º 175
        if (d.h > 0 && d.h < 3) { d.h = parseFloat((d.h * 100).toFixed(1)); modified = true; }
        if (d.jump > 0 && d.jump < 4) { d.jump = Math.round(d.jump * 100); modified = true; }
        
        if(modified) {
            GLOBAL_DATA[i] = calculateRowData(d);
            fixCount++;
        }
        
        // ==========================================
        // 4. æ·±åº¦å¼‚å¸¸æ£€æµ‹ (0å€¼ã€ç©ºå€¼åŠèŒƒå›´æ£€æµ‹)
        // ==========================================
        d.warn = {}; d.warnMsg = {}; d.errList = [];
        let hasWarn = false;

        const addWarn = (field, msg) => {
            d.warn[field] = true;
            d.warnMsg[field] = msg;
            const fieldNameMap = {
                'h':'èº«é«˜','w':'ä½“é‡','lung':'è‚ºæ´»é‡','r50':'50ç±³','sit':'ä½“å‰å±ˆ',
                'jump':'ç«‹å®šè·³è¿œ','pull':'å¼•ä½“å‘ä¸Š','situp':'ä»°å§èµ·å','r1000':'1000ç±³','r800':'800ç±³'
            };
            const fName = fieldNameMap[field] || field;
            d.errList.push(`${fName}: ${msg}`);
            hasWarn = true;
        };

        // (A) å®šä¹‰å„é¡¹èŒƒå›´æ ‡å‡†
        const checkRange = (field, val, min, max, canBeZero = false) => {
            if (val === '' || val === null || val === undefined) {
                addWarn(field, "æœªå¡«/ç©ºå€¼");
                return;
            }
            const num = parseFloat(val);
            if (!canBeZero && num === 0) {
                addWarn(field, "æ•°å€¼ä¸èƒ½ä¸º0");
            } else if (num < min || num > max) {
                addWarn(field, `è¶…å‡ºèŒƒå›´(${min}-${max})`);
            }
        };

        // (B) æ‰§è¡Œæ£€æµ‹é€»è¾‘
        checkRange('h', d.h, 100, 200);           // èº«é«˜èŒƒå›´ 100-200
        checkRange('w', d.w, 20, 120);            // ä½“é‡èŒƒå›´ 20-120
        checkRange('lung', d.lung, 500, 7000);    // è‚ºæ´»é‡èŒƒå›´ 500-7000
        checkRange('r50', d.r50, 5.5, 16);        // 50ç±³è·‘èŒƒå›´ 5.5-16
        checkRange('jump', d.jump, 100, 320);     // ç«‹å®šè·³è¿œèŒƒå›´ 100-320
        checkRange('sit', d.sit, -20, 40, true);  // åä½ä½“å‰å±ˆèŒƒå›´ -20-40 (å…è®¸0æˆ–è´Ÿæ•°)

        // ä»°å§èµ·åèŒƒå›´æ£€æµ‹ (3-70ï¼Œä»…æ£€æµ‹å¥³ç”Ÿ)
        if (!d.isMale) {
            checkRange('situp', d.situp, 3, 70);
        }

        // å¼•ä½“å‘ä¸ŠèŒƒå›´æ£€æµ‹ (0-40ï¼Œä»…æ£€æµ‹ç”·ç”Ÿï¼Œå…è®¸ä¸º0)
        if (d.isMale) {
            checkRange('pull', d.pull, 0, 40, true);
        }

        // é•¿è·‘ 0 å€¼ä¸ç©ºå€¼æ£€æŸ¥
        const runVal = d[runKey];
        if (runVal === '' || runVal === null || runVal === undefined) {
            addWarn(runKey, "æœªå¡«/ç©ºå€¼");
        } else if (parseFloat(runVal) === 0) {
            addWarn(runKey, "æ•°å€¼ä¸èƒ½ä¸º0");
        }

        if(hasWarn) {
            WARN_LIST.push(i); 
        }
    });
    
    renderTable();
    saveData();
    
    const navBtn = document.getElementById('btnWarnNav');
    if(WARN_LIST.length > 0) {
        WARN_PTR = 0;
        navBtn.style.display = 'inline-flex';
        navBtn.innerText = `âš ï¸ å®šä½å¼‚å¸¸ (1/${WARN_LIST.length})`;
        alert(`æ ¡éªŒå®Œæˆï¼\nâœ… è‡ªåŠ¨ä¿®æ­£æ ¼å¼: ${fixCount}å¤„\nâš ï¸ å¼‚å¸¸(è¶…å‡ºèŒƒå›´/0å€¼/æœªå¡«): ${WARN_LIST.length}äºº`);
    } else {
        navBtn.style.display = 'none';
        alert(`æ ¡éªŒé€šè¿‡ï¼æ‰€æœ‰æ•°æ®å‡åœ¨åˆç†èŒƒå›´å†…ã€‚`);
    }
}
function openOptimizeDialog() {
    const rate = prompt("è¯·è¾“å…¥å…¨æ ¡ç›®æ ‡ä¼˜è‰¯ç‡ï¼ˆ%ï¼‰\nä¾‹å¦‚è¾“å…¥ 85 ä»£è¡¨ç›®æ ‡æ˜¯è®©å…¨æ ¡ä¼˜è‰¯ç‡è¾¾åˆ° 85%", "85");
    if(rate) autoOptimize(parseFloat(rate));
}

function autoOptimize(targetRate) {
    if(!GLOBAL_DATA.length) return;
    
    // 1. å¹´çº§ä¼˜å…ˆçº§å®šä¹‰
    const gradePriority = { 'é«˜ä¸‰':0, 'åˆä¸‰':1, 'é«˜äºŒ':2, 'åˆäºŒ':3, 'é«˜ä¸€':4, 'åˆä¸€':5 };
    
    const getGradeScore = (d) => {
        const gc = d.gc || '';
        for(let g in gradePriority) if(gc.includes(g)) return gradePriority[g];
        return 99; 
    };

    // 2. ç­›é€‰å…¨æ ¡èŒƒå›´å†…çš„æ‰€æœ‰â€œæ½œåŠ›è‚¡â€ (74 <= åˆ†æ•° < 80)
    let candidates = GLOBAL_DATA.map((d, index) => ({ data: d, index: index })) 
        .filter(item => {
            const t = parseFloat(item.data.res.total);
            return !item.data.res.err && t < 80 && t >= 74; // ä¸¥æ ¼é™å®š 75-79.9
        });

    // 3. å¯¹æ½œåŠ›è‚¡è¿›è¡Œå…¨å±€æ’åº
    candidates.sort((a, b) => {
        const gradeScoreA = getGradeScore(a.data);
        const gradeScoreB = getGradeScore(b.data);
        if(gradeScoreA !== gradeScoreB) return gradeScoreA - gradeScoreB;
        
        return parseFloat(b.data.res.total) - parseFloat(a.data.res.total);
    });

    // 4. è®¡ç®—å½“å‰å…¨æ ¡ä¼˜è‰¯ç‡
    const calcGlobalRate = () => {
        const totalCount = GLOBAL_DATA.length;
        if(totalCount === 0) return 0;
        const goodCount = GLOBAL_DATA.filter(d => parseFloat(d.res.total) >= 80).length;
        return (goodCount / totalCount) * 100;
    };

    let totalModified = 0;

    // 5. å¼€å§‹å…¨å±€å¾ªç¯ä¼˜åŒ–
    for(let item of candidates) {
        if(calcGlobalRate() >= targetRate) {
            break; 
        }

        const idx = item.index; 
        const currentD = GLOBAL_DATA[idx];
        let isModified = false;

        const modifyPipeline = [
            {
                key: 'r50',
                action: () => {
                    if(currentD.r50) {
                        let reduction = (Math.random() * 0.4 + 0.1); 
                        currentD.r50 = (parseFloat(currentD.r50) - reduction).toFixed(2);
                        currentD.mod50 = true;
                        return true;
                    }
                    return false;
                }
            },
            {
                key: 'run',
                action: () => {
                    const runKey = currentD.isMale ? 'r1000' : 'r800';
                    if (currentD[runKey] && currentD[runKey] > 0) {
                        // ç»Ÿä¸€è½¬ä¸ºç§’è¿›è¡Œè®¡ç®—
                        let t = parseTime(currentD[runKey]);
                        // å‡å°‘1-20ç§’ (å³0.01-0.20åˆ†)
                        let reduction = Math.floor(Math.random() * 20) + 1; 
                        t = Math.max(180, t - reduction);
                        
                        // å¼ºåˆ¶è½¬å› m.ss æ ¼å¼å­˜å‚¨ (å¦‚ 4.12)
                        currentD[runKey] = secondsToMSS(t);
                        
                        currentD.modRun = true;
                        return true;
                    }
                    return false;
                }
            },
            {
                key: 'lung',
                action: () => {
                    if (currentD.lung) {
                        let increase = Math.floor(Math.random() * 400) + 100; 
                        currentD.lung = Math.round(parseFloat(currentD.lung) + increase);
                        currentD.modLung = true;
                        return true;
                    }
                    return false;
                }
            },
            {
                key: 'jump',
                action: () => {
                    if (currentD.jump) {
                        let increase = Math.floor(Math.random() * 10) + 5; 
                        currentD.jump = Math.round(parseFloat(currentD.jump) + increase);
                        currentD.modJump = true;
                        return true;
                    }
                    return false;
                }
            }
        ];

        for (let step of modifyPipeline) {
            if(step.action()) {
                isModified = true;
                GLOBAL_DATA[idx] = calculateRowData(currentD);
            
                if(parseFloat(GLOBAL_DATA[idx].res.total) >= 80) {
                    break; 
                }
            }
        }

        if(isModified) {
            totalModified++;
            GLOBAL_DATA[idx].modified = true;
        }
    }

    renderTable();
    saveData();
    alert(`å…¨æ ¡ä¼˜åŒ–å®Œæˆï¼\nå…±å¾®è°ƒäº† ${totalModified} äººã€‚\nå½“å‰å…¨æ ¡ä¼˜è‰¯ç‡ï¼š${calcGlobalRate().toFixed(2)}%`);
}

// 6ï¸âƒ£ å¯¼å‡ºå…¨æ ¡åŸºæœ¬ä¿¡æ¯æ±‡æ€»è¡¨ (ä¿®å¤ç‰ˆï¼šæ‰€æœ‰æ°‘æ—ä»£ç å‡ä¸å«å‰å¯¼é›¶)
function exportAllBasicInfo() {
    if (!GLOBAL_DATA.length) { alert("æ— æ•°æ®ï¼Œæ— æ³•å¯¼å‡º"); return; }
    const wb = XLSX.utils.book_new();
    
    // æ°‘æ—ä»£ç æ˜ å°„è¡¨ï¼šå…¨éƒ¨æ”¹ä¸ºä¸å¸¦ 0 çš„æ•°å­—
    const NATION_MAP = { 
        "æ±‰æ—": "1", "è’™å¤æ—": "2", "å›æ—": "3", "è—æ—": "4", "ç»´å¾å°”æ—": "5", "è‹—æ—": "6", "å½æ—": "7", "å£®æ—": "8", "å¸ƒä¾æ—": "9", "æœé²œæ—": "10", "æ»¡æ—": "11", "ä¾—æ—": "12", "ç‘¶æ—": "13", "ç™½æ—": "14", "åœŸå®¶æ—": "15", "å“ˆå°¼æ—": "16", "å“ˆè¨å…‹æ—": "17", "å‚£æ—": "18", "é»æ—": "19", "å‚ˆåƒ³æ—": "20", "ä½¤æ—": "21", "ç•²æ—": "22", "é«˜å±±æ—": "23", "æ‹‰ç¥œæ—": "24", "æ°´æ—": "25", "ä¸œä¹¡æ—": "26", "çº³è¥¿æ—": "27", "æ™¯é¢‡æ—": "28", "æŸ¯å°”å…‹å­œæ—": "29", "åœŸæ—": "30", "è¾¾æ–¡å°”æ—": "31", "ä»«ä½¬æ—": "32", "ç¾Œæ—": "33", "å¸ƒæœ—æ—": "34", "æ’’æ‹‰æ—": "35", "æ¯›å—æ—": "36", "ä»¡ä½¬æ—": "37", "é”¡ä¼¯æ—": "38", "é˜¿æ˜Œæ—": "39", "æ™®ç±³æ—": "40", "å¡”å‰å…‹æ—": "41", "æ€’æ—": "42", "ä¹Œå­œåˆ«å…‹æ—": "43", "ä¿„ç½—æ–¯æ—": "44", "é„‚æ¸©å…‹æ—": "45", "å¾·æ˜‚æ—": "46", "ä¿å®‰æ—": "47", "è£•å›ºæ—": "48", "äº¬æ—": "49", "å¡”å¡”å°”æ—": "50", "ç‹¬é¾™æ—": "51", "é„‚ä¼¦æ˜¥æ—": "52", "èµ«å“²æ—": "53", "é—¨å·´æ—": "54", "çå·´æ—": "55", "åŸºè¯ºæ—": "56", "å…¶ä»–": "57", "å¤–å›½è¡€ç»Ÿ": "58" 
    };

    const fmtNationToCode = (val) => {
        if(!val) return '';
        const s = String(val).trim();
        // å¦‚æœæ˜¯çº¯æ•°å­—å­—ç¬¦ä¸²ï¼ˆå¦‚ "01", "02"ï¼‰ï¼Œè½¬ä¸ºæ•´æ•°å†è½¬å›å­—ç¬¦ä¸²ä»¥å»æ‰ 0
        if (/^\d+$/.test(s)) return String(parseInt(s, 10));
        // å¦‚æœæ˜¯ä¸­æ–‡åç§°ï¼ŒæŸ¥è¡¨è¿”å›å¯¹åº”çš„ä¸å¸¦ 0 çš„ä»£ç 
        return NATION_MAP[s] || s;
    };

    const sortedData = [...GLOBAL_DATA].sort((a, b) => getClassRank(a.gc) - getClassRank(b.gc));
    const header = ['ç­çº§ç¼–å·', 'ç­çº§åç§°', 'å­¦ç±å·', 'æ°‘æ—ä»£ç ', 'å§“å', 'æ€§åˆ«', 'å‡ºç”Ÿæ—¥æœŸ', 'å­¦ç”Ÿæ¥æº', 'èº«ä»½è¯å·', 'å®¶åº­ä½å€'];

    const sheetData = sortedData.map(d => {
        const genderRaw = String(d.ge || '').trim();
        const genderCode = (genderRaw === '1' || genderRaw.includes('ç”·')) ? 1 : 2;
        return [
            d.classId || '',               
            getStandardClassName(d.gc),    
            d.stuCode || '',               
            fmtNationToCode(d.nation),     // åº”ç”¨æ–°æ°‘æ—ä»£ç é€»è¾‘
            d.name || '',                  
            genderCode,                    
            d.dob || '',                      
            '',                            
            '',                            
            d.addr || ''                   
        ];
    });

    sheetData.unshift(header);
    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    XLSX.utils.book_append_sheet(wb, ws, "åŸºæœ¬ä¿¡æ¯æ±‡æ€»");
    XLSX.writeFile(wb, 'å…¨æ ¡åŸºæœ¬ä¿¡æ¯æ±‡æ€»è¡¨.xlsx');
}
// ğŸ†• å¯¼å‡ºç­çº§ä¿¡æ¯ (ä¸¥æ ¼å¯¹ç…§å›¾ç‰‡æ ¼å¼ï¼šå¹´çº§ç¼–å·ã€ç­çº§ç¼–å·ã€ç­çº§åç§°)
function exportClassInfo() {
    if (!GLOBAL_DATA.length) { 
        alert("å½“å‰æš‚æ— æ•°æ®ï¼Œè¯·å…ˆå¯¼å…¥åŸºæœ¬ä¿¡æ¯ã€‚"); 
        return; 
    }
    
    const wb = XLSX.utils.book_new();
    
    // ä½¿ç”¨ Map æå–å”¯ä¸€çš„ç­çº§ä¿¡æ¯ï¼Œç¡®ä¿ä¸é‡å¤å¯¼å‡º
    const classMap = new Map();
    GLOBAL_DATA.forEach(d => {
        // åªæœ‰å½“ç­çº§ç¼–å·å­˜åœ¨ä¸”å°šæœªè®°å½•æ—¶æ‰æ·»åŠ 
        if (d.classId && !classMap.has(d.classId)) {
            classMap.set(d.classId, {
                gradeId: d.gradeId || '',
                classId: d.classId,
                className: getStandardClassName(d.gc) || d.gc
            });
        }
    });

    // å°†æå–åˆ°çš„ç­çº§æŒ‰ç­çº§ç¼–å·è¿›è¡Œå‡åºæ’åˆ—
    const sortedClasses = Array.from(classMap.values()).sort((a, b) => {
        return String(a.classId).localeCompare(String(b.classId));
    });

    // å®šä¹‰è¡¨å¤´ (ä¸¥æ ¼åŒ¹é…å›¾ç‰‡ A-C åˆ—)
    const header = ["å¹´çº§ç¼–å·", "ç­çº§ç¼–å·", "ç­çº§åç§°"];
    
    // ç”Ÿæˆæ•°æ®è¡Œ
    const body = sortedClasses.map(c => [
        c.gradeId, 
        c.classId, 
        c.className
    ]);

    // åˆ›å»ºå·¥ä½œè¡¨
    const ws = XLSX.utils.aoa_to_sheet([header, ...body]);

    // è®¾ç½®åˆ—å®½ä»¥ä¾¿äºæŸ¥çœ‹
    ws['!cols'] = [
        { wch: 10 }, // å¹´çº§ç¼–å·
        { wch: 15 }, // ç­çº§ç¼–å·
        { wch: 25 }  // ç­çº§åç§°
    ];

    // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿å¹¶å¯¼å‡º
    XLSX.utils.book_append_sheet(wb, ws, "ç­çº§æ±‡æ€»");
    XLSX.writeFile(wb, 'å…¨æ ¡ç­çº§ä¿¡æ¯æ±‡æ€»è¡¨.xlsx');
}
// 7ï¸âƒ£ å¯¼å‡ºå…¨æ ¡ä¸ŠæŠ¥è¡¨ (ä¿®æ­£æ°‘æ—ä»£ç ï¼šæ‰€æœ‰æ°‘æ—å‡ä¸å«å‰å¯¼é›¶)
function exportAllData() {
    if(!GLOBAL_DATA.length) { alert("æ— æ•°æ®"); return; }
    const wb = XLSX.utils.book_new();
    
    // ç»Ÿä¸€æ˜ å°„è¡¨
    const NATION_MAP = { "æ±‰æ—": "1", "è’™å¤æ—": "2", "å›æ—": "3", "è—æ—": "4", "ç»´å¾å°”æ—": "5", "è‹—æ—": "6", "å½æ—": "7", "å£®æ—": "8", "å¸ƒä¾æ—": "9", "æœé²œæ—": "10", "æ»¡æ—": "11", "ä¾—æ—": "12", "ç‘¶æ—": "13", "ç™½æ—": "14", "åœŸå®¶æ—": "15", "å“ˆå°¼æ—": "16", "å“ˆè¨å…‹æ—": "17", "å‚£æ—": "18", "é»æ—": "19", "å‚ˆåƒ³æ—": "20", "ä½¤æ—": "21", "ç•²æ—": "22", "é«˜å±±æ—": "23", "æ‹‰ç¥œæ—": "24", "æ°´æ—": "25", "ä¸œä¹¡æ—": "26", "çº³è¥¿æ—": "27", "æ™¯é¢‡æ—": "28", "æŸ¯å°”å…‹å­œæ—": "29", "åœŸæ—": "30", "è¾¾æ–¡å°”æ—": "31", "ä»«ä½¬æ—": "32", "ç¾Œæ—": "33", "å¸ƒæœ—æ—": "34", "æ’’æ‹‰æ—": "35", "æ¯›å—æ—": "36", "ä»¡ä½¬æ—": "37", "é”¡ä¼¯æ—": "38", "é˜¿æ˜Œæ—": "39", "æ™®ç±³æ—": "40", "å¡”å‰å…‹æ—": "41", "æ€’æ—": "42", "ä¹Œå­œåˆ«å…‹æ—": "43", "ä¿„ç½—æ–¯æ—": "44", "é„‚æ¸©å…‹æ—": "45", "å¾·æ˜‚æ—": "46", "ä¿å®‰æ—": "47", "è£•å›ºæ—": "48", "äº¬æ—": "49", "å¡”å¡”å°”æ—": "50", "ç‹¬é¾™æ—": "51", "é„‚ä¼¦æ˜¥æ—": "52", "èµ«å“²æ—": "53", "é—¨å·´æ—": "54", "çå·´æ—": "55", "åŸºè¯ºæ—": "56", "å…¶ä»–": "57", "å¤–å›½è¡€ç»Ÿ": "58" };

    const fmtNationCode = (val) => {
        if(!val && val !== 0) return null;
        const s = String(val).trim();
        // è‡ªåŠ¨å‰¥ç¦»æ•°å­—å‰å¯¼é›¶
        if (/^\d+$/.test(s)) return String(parseInt(s, 10));
        return NATION_MAP[s] || s; 
    };
    const header = [
        "å¹´çº§ç¼–å·", "ç­çº§ç¼–å·", "ç­çº§åç§°", "å­¦ç±å·", "æ°‘æ—ä»£ç ", 
        "å§“å", "æ€§åˆ«", "å‡ºç”Ÿæ—¥æœŸ", "å®¶åº­ä½å€", 
        "èº«é«˜", "ä½“é‡", "è‚ºæ´»é‡", "50ç±³è·‘", "ç«‹å®šè·³è¿œ", 
        "åä½ä½“å‰å±ˆ", "800ç±³è·‘", "1000ç±³è·‘", "ä¸€åˆ†é’Ÿä»°å§èµ·å", "å¼•ä½“å‘ä¸Š"
    ];

    const body = GLOBAL_DATA.map(d => {
        const isMale = normalizeGender(d.ge) === 'ç”·';
        const fv = (v) => (v === 0 || v) ? v : null;
        const getVal = (v1, v2) => (v1 !== '' && v1 !== null && v1 !== undefined) ? v1 : ((v2 !== '' && v2 !== null && v2 !== undefined) ? v2 : null);

        let r1000Val = isMale ? fmtTimeExport(getVal(d.r1000, d.r800)) : null; 
        let r800Val = !isMale ? fmtTimeExport(getVal(d.r800, d.r1000)) : null;
        let situpVal = !isMale ? getVal(d.situp, d.pull) : null; 
        let pullVal = isMale ? getVal(d.pull, d.situp) : null;  

        return [
            fv(d.gradeId), fv(d.classId), getStandardClassName(d.gc) || d.gc, 
            fv(d.stuCode), fmtNationCode(d.nation), fv(d.name),
            isMale ? 1 : 2, // ä¿®æ­£æ€§åˆ«å¯¼å‡º
            fv(d.dob), fv(d.addr),
            fv(d.h), fv(d.w), fv(d.lung), fv(d.r50), fv(d.jump), fv(d.sit),
            r800Val, r1000Val, situpVal, pullVal
        ];
    });

    const ws = XLSX.utils.aoa_to_sheet([header, ...body]);
    XLSX.utils.book_append_sheet(wb, ws, "ä¸ŠæŠ¥æ•°æ®æ±‡æ€»");
    XLSX.writeFile(wb, 'ä½“æµ‹ä¸ŠæŠ¥æ•°æ®.xlsx');
}
// ==========================================
// åŠŸèƒ½ï¼šåˆ†ç­å¯¼å‡ºï¼ˆç©ºè¡¨ï¼‰
// ==========================================
function exportEmptyTemplate() {
    if(!GLOBAL_DATA.length) { alert("æ— æ•°æ®"); return; }
    
    const wb = XLSX.utils.book_new();
    
    // è¾…åŠ©å‡½æ•°
    const fmtGender = (v) => {
        const s = String(v).trim();
        return (s === '1' || s === 'ç”·') ? 'ç”·' : ((s === '2' || s === 'å¥³') ? 'å¥³' : v);
    };

    // 1. æ•°æ®åˆ†ç»„
    const classMap = {};
    GLOBAL_DATA.forEach(d => {
        const cls = d.gc || 'æœªåˆ†ç±»';
        if(!classMap[cls]) classMap[cls] = [];
        classMap[cls].push(d);
    });
    
    // 2. å®šä¹‰è¡¨å¤´ (å¯¹åº”å›¾ä¸€)
    const header = ['å­¦ç±å·', 'ç­çº§', 'å§“å', 'æ€§åˆ«', 'èº«é«˜', 'ä½“é‡', 'è‚ºæ´»é‡', '50ç±³è·‘', 'åä½ä½“å‰å±ˆ', 'ä¸€åˆ†é’Ÿä»°å§èµ·å', 'ç«‹å®šè·³è¿œ', 'å¼•ä½“å‘ä¸Š', '1000ç±³è·‘', '800ç±³è·‘'];
    
    const sortedClasses = Object.keys(classMap).sort((a,b) => getClassRank(a) - getClassRank(b));
    
    sortedClasses.forEach(clsName => {
        const data = classMap[clsName];
        
        // ç”Ÿæˆæ•°æ®è¡Œï¼šåªå¡«åŸºæœ¬ä¿¡æ¯ï¼Œæˆç»©æ ç•™ç©ºæ–¹ä¾¿è®°å½•
        const sheetData = data.map(d => [
            d.stuCode || '',   // å­¦ç±å·
            d.gc,              // ç­çº§
            d.name,            // å§“å
            fmtGender(d.ge),   // æ€§åˆ«
            '', '', '', '', '', '', '', '', '', '' // æˆç»©åˆ—ç•™ç©º
        ]);
        
        // æ·»åŠ è¡¨å¤´
        sheetData.unshift(header);
        
        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        
        // è®¾ç½®åˆ—å®½
        ws['!cols'] = [
            {wch: 18}, {wch: 12}, {wch: 10}, {wch: 6}, 
            {wch: 8}, {wch: 8}, {wch: 10}, {wch: 10}, 
            {wch: 12}, {wch: 15}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}
        ];

        XLSX.utils.book_append_sheet(wb, ws, clsName);
    });

    XLSX.writeFile(wb, 'åˆ†ç­è®°å½•è¡¨_ç©ºè¡¨.xlsx');
}
// åŠŸèƒ½ï¼šåˆ†ç­å¯¼å‡ºï¼ˆå¸¦è¯„åˆ†ï¼‰
// ==========================================
function exportScoreTable() {
    if(!GLOBAL_DATA.length) { alert("æ— æ•°æ®"); return; }
    
    const wb = XLSX.utils.book_new();
    
    const fmtGender = (v) => {
        const s = String(v).trim();
        return (s === '1' || s === 'ç”·') ? 'ç”·' : ((s === '2' || s === 'å¥³') ? 'å¥³' : v);
    };
    
    // è·‘æ­¥æ—¶é—´æ ¼å¼åŒ–
    const fmtRun = (v) => {
        if(!v || v === '' || v === '-') return '';
        if(String(v).includes("'")) return v; 
        const num = parseFloat(v);
        if(isNaN(num)) return v;
        const m = Math.floor(num);
        let s = Math.round((num - m) * 100);
        const sStr = s < 10 ? '0' + s : s;
        return `${m}'${sStr}`;
    };

    const classMap = {};
    GLOBAL_DATA.forEach(d => {
        const cls = d.gc || 'æœªåˆ†ç±»';
        if(!classMap[cls]) classMap[cls] = [];
        classMap[cls].push(d);
    });
    
    // è¡¨å¤´ç»“æ„ (åŒè¡Œè¡¨å¤´)
    const headerRows = [
        ['å§“å', 'æ€§åˆ«', '50ç±³è·‘ (20%)', '', 'ç«‹å®šè·³è¿œ (10%)', '', 'åä½ä½“å‰å±ˆ (10%)', '', '800ç±³è·‘ (20%)', '', '1000ç±³è·‘ (20%)', '', 'ä»°å§èµ·å (10%)', '', 'å¼•ä½“å‘ä¸Š (10%)', '', 'é™„åŠ åˆ†', 'æ€»åˆ†', 'ç­‰çº§'],
        ['', '', 'æˆç»©', 'å¾—åˆ†', 'æˆç»©', 'å¾—åˆ†', 'æˆç»©', 'å¾—åˆ†', 'æˆç»©', 'å¾—åˆ†', 'æˆç»©', 'å¾—åˆ†', 'æˆç»©', 'å¾—åˆ†', 'æˆç»©', 'å¾—åˆ†', '', '', '']
    ];

    const sortedClasses = Object.keys(classMap).sort((a,b) => getClassRank(a) - getClassRank(b));
    
    sortedClasses.forEach(clsName => {
        const data = classMap[clsName];
        
        const sheetData = [];
        // å‹å…¥åŒè¡Œè¡¨å¤´
        sheetData.push([...headerRows[0]]);
        sheetData.push([...headerRows[1]]);
        
        data.forEach(d => {
            const r = d.res || {};
            const isMale = d.isMale;
            
            // å‡†å¤‡æ•°æ®
            const row = [
                d.name,
                fmtGender(d.ge),
                
                // 50ç±³
                d.r50, r.s50,
                
                // è·³è¿œ
                d.jump, r.sJump,
                
                // åä½
                d.sit, r.sSit,
                
                // 800ç±³ (ä»…å¥³ç”Ÿ)
                !isMale ? fmtRun(d.r800) : '', !isMale ? r.sRun : '',
                
                // 1000ç±³ (ä»…ç”·ç”Ÿ)
                isMale ? fmtRun(d.r1000) : '', isMale ? r.sRun : '',
                
                // ä»°å§ (ä»…å¥³ç”Ÿ)
                !isMale ? d.situp : '', !isMale ? r.sStr : '',
                
                // å¼•ä½“ (ä»…ç”·ç”Ÿ)
                isMale ? d.pull : '', isMale ? r.sStr : '',
                
                // æ±‡æ€»
                r.bonus,
                r.total,
                r.g
            ];
            sheetData.push(row);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        
        // è®¾ç½®åˆå¹¶å•å…ƒæ ¼ (è¡¨å¤´åˆå¹¶)
        ws['!merges'] = [
            {s:{r:0,c:0}, e:{r:1,c:0}}, // å§“å
            {s:{r:0,c:1}, e:{r:1,c:1}}, // æ€§åˆ«
            {s:{r:0,c:2}, e:{r:0,c:3}}, // 50ç±³
            {s:{r:0,c:4}, e:{r:0,c:5}}, // è·³è¿œ
            {s:{r:0,c:6}, e:{r:0,c:7}}, // åä½
            {s:{r:0,c:8}, e:{r:0,c:9}}, // 800ç±³
            {s:{r:0,c:10}, e:{r:0,c:11}}, // 1000ç±³
            {s:{r:0,c:12}, e:{r:0,c:13}}, // ä»°å§
            {s:{r:0,c:14}, e:{r:0,c:15}}, // å¼•ä½“
            {s:{r:0,c:16}, e:{r:1,c:16}}, // é™„åŠ åˆ†
            {s:{r:0,c:17}, e:{r:1,c:17}}, // æ€»åˆ†
            {s:{r:0,c:18}, e:{r:1,c:18}}  // ç­‰çº§
        ];
        
        // è®¾ç½®åˆ—å®½
        ws['!cols'] = [
            {wch: 10}, {wch: 5}, // å§“å æ€§åˆ«
            {wch: 8}, {wch: 5},  // 50ç±³
            {wch: 8}, {wch: 5},  // è·³è¿œ
            {wch: 8}, {wch: 5},  // åä½
            {wch: 10}, {wch: 5}, // 800ç±³
            {wch: 10}, {wch: 5}, // 1000ç±³
            {wch: 8}, {wch: 5},  // ä»°å§
            {wch: 8}, {wch: 5},  // å¼•ä½“
            {wch: 6}, {wch: 6}, {wch: 6} // é™„åŠ  æ€»åˆ† ç­‰çº§
        ];

        XLSX.utils.book_append_sheet(wb, ws, clsName);
    });

    XLSX.writeFile(wb, 'åˆ†ç­æˆç»©è¡¨_å¸¦è¯„åˆ†.xlsx');
}
// ==========================================
// æŠ¥è¡¨é€»è¾‘ (å·²ä¿®å¤)
function getAnalysisData() {
    const baseObj = () => ({tot:0, exc:0, good:0, pass:0, fail:0});
    const stats = { 'å…¨æ ¡': baseObj(), 'åˆä¸­': baseObj(), 'é«˜ä¸­': baseObj() };
    const itemStats = {}; 
    const classStats = {};
    const existGrades = new Set();

    GLOBAL_DATA.forEach(d => { if (!d.res.err && d.grade) existGrades.add(d.grade); });

    existGrades.forEach(g => {
        stats[g] = baseObj();
        itemStats[g] = { 
            lungM:{c:0,t:0}, lungF:{c:0,t:0}, r50M:{c:0,t:0}, r50F:{c:0,t:0}, 
            jumpM:{c:0,t:0}, jumpF:{c:0,t:0}, sitM:{c:0,t:0}, sitF:{c:0,t:0}, 
            runM:{c:0,t:0}, runF:{c:0,t:0}, strM:{c:0,t:0}, strF:{c:0,t:0}
        };
    });

    GLOBAL_DATA.forEach(d => {
        if (d.res.err) return;
        const cls = d.gc || 'æœªçŸ¥';
        const grade = d.grade;
        const suffix = d.isMale ? 'M' : 'F';
        
        if(!classStats[cls]) classStats[cls] = baseObj();

        const updateStat = (o) => {
            o.tot++;
            const t = parseFloat(d.res.total);
            if(t>=90) o.exc++;
            else if(t>=80) o.good++;
            else if(t>=60) o.pass++;
            else o.fail++;
        };

        updateStat(stats['å…¨æ ¡']);
        if(stats[grade]) updateStat(stats[grade]);
        if(classStats[cls]) updateStat(classStats[cls]);

        if(grade.includes('åˆ')) updateStat(stats['åˆä¸­']);
        if(grade.includes('é«˜')) updateStat(stats['é«˜ä¸­']);

        const chk = (k, s) => { if(s!==null && s!=='-' && s!=='' && !isNaN(s)) { itemStats[grade][k].t++; if(s>=80) itemStats[grade][k].c++; } };
        if(itemStats[grade]) {
            chk('lung'+suffix, d.res.sLung); 
            chk('r50'+suffix, d.res.s50); 
            chk('jump'+suffix, d.res.sJump);
            chk('sit'+suffix, d.res.sSit); 
            chk('run'+suffix, d.res.sRun); 
            chk('str'+suffix, d.res.sStr);
        }
    });
    return { stats, itemStats, classStats, existGrades };
}

// ç”Ÿæˆåˆ†ææŠ¥å‘Š (ä¿®å¤ç‰ˆï¼šä¸¥æ ¼åŒ¹é…æˆªå›¾ 6 åˆ—å¸ƒå±€)
function genReport() {
    const { stats, itemStats, classStats, existGrades } = getAnalysisData();
    const pct = (n,t) => t ? ((n/t)*100).toFixed(1)+'%' : '0%';
    const fmt = (n,t) => `${n} (${pct(n,t)})`;
    const getPct = (n,t) => t ? parseFloat(((n/t)*100).toFixed(1)) : 0;

    // --- 1. å…¨æ ¡æ•°æ®æ±‡æ€» (Table + Chart) ---
    let h1 = `<table class="report-table"><tr class="report-header-blue"><th>å¯¹è±¡</th><th>æ€»æ•°</th><th>ä¼˜ç§€</th><th>ä¼˜è‰¯</th><th>åŠæ ¼</th><th>ä¸åŠæ ¼</th></tr>`;
    
    // æ±‡æ€»è¡¨çš„é¡ºåºå®šä¹‰
    const summaryOrder = ['åˆä¸€','åˆäºŒ','åˆä¸‰','åˆä¸­','é«˜ä¸€','é«˜äºŒ','é«˜ä¸‰','é«˜ä¸­','å…¨æ ¡'];
    
    const overallChartData = { 
        labels: [], 
        datasets: [{
            label: 'ä¼˜è‰¯ç‡ (%)', 
            data: [], 
            backgroundColor: [], 
            borderWidth: 1
        }] 
    };
    
    summaryOrder.forEach(k => {
        if(!stats[k] || stats[k].tot === 0) return;
        const s = stats[k];
        const passPct = getPct(s.exc+s.good, s.tot);
        
        // æ ·å¼ä¸é¢œè‰²é€»è¾‘
        let rowStyle = '';
        let barColor = '#4caf50'; 

        if (k === 'åˆä¸­') {
            rowStyle = 'style="background-color: #E3F2FD; font-weight: bold;"'; 
            barColor = '#2196f3';
        } else if (k === 'é«˜ä¸­') {
            rowStyle = 'style="background-color: #FFF3E0; font-weight: bold;"'; 
            barColor = '#ff9800'; 
        } else if (k === 'å…¨æ ¡') {
            rowStyle = 'style="background-color: #E8F5E9; font-weight: bold; border-top: 2px solid #999;"'; 
            barColor = '#9c27b0'; 
        }

        h1 += `<tr ${rowStyle}>
            <td>${k}</td>
            <td>${s.tot}</td>
            <td>${fmt(s.exc,s.tot)}</td>
            <td>${fmt(s.exc+s.good,s.tot)}</td>
            <td>${fmt(s.tot-s.fail,s.tot)}</td>
            <td class="text-fail">${fmt(s.fail,s.tot)}</td>
        </tr>`;
        
        overallChartData.labels.push(k);
        overallChartData.datasets[0].data.push(passPct);
        overallChartData.datasets[0].backgroundColor.push(barColor); 
    });
    h1 += '</table>';
    document.getElementById('report-overall').innerHTML = h1;
    renderChart('chart-overall', 'bar', 'å„å¹´çº§ä¼˜è‰¯ç‡ (%)', overallChartData, {yTitle: 'ä¼˜è‰¯ç‡ (%)', max: 100});


    // --- 2. å„é¡¹ç›®ä¼˜è‰¯ç‡  ---
    let h2 = `<table class="report-table"><tr class="report-header-blue"><th>å¹´çº§</th><th>è‚ºæ´»é‡(ç”·)</th><th>è‚ºæ´»é‡(å¥³)</th><th>50ç±³(ç”·)</th><th>50ç±³(å¥³)</th><th>ç«‹å®šè·³è¿œ(ç”·)</th><th>ç«‹å®šè·³è¿œ(å¥³)</th><th>åä½ä½“å‰å±ˆ(ç”·)</th><th>åä½ä½“å‰å±ˆ(å¥³)</th><th>1000ç±³</th><th>800ç±³</th><th>å¼•ä½“å‘ä¸Š</th><th>ä»°å§èµ·å</th></tr>`;
    
    // â¬‡ï¸ å®šä¹‰ä¸¥æ ¼çš„æ˜¾ç¤ºé¡ºåº â¬‡ï¸
    const targetItemOrder = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'é«˜ä¸€', 'é«˜äºŒ', 'é«˜ä¸‰'];
    
    // è¿‡æ»¤å‡ºå½“å‰æ•°æ®ä¸­å®é™…å­˜åœ¨çš„å¹´çº§ï¼Œå¹¶æŒ‰ä¸Šè¿°é¡ºåºæ’åˆ—
    const sortedItemGrades = targetItemOrder.filter(g => existGrades.has(g));

    const itemChartData = { 
        labels: sortedItemGrades, // ä½¿ç”¨æ’åºåçš„å¹´çº§åˆ—è¡¨
        datasets: [
            {label: 'è‚ºæ´»é‡(ç”·)', data: [], backgroundColor: '#00b0f0'},
            {label: 'è‚ºæ´»é‡(å¥³)', data: [], backgroundColor: '#ffc000'},
            {label: '50ç±³(ç”·)', data: [], backgroundColor: '#4caf50'},
            {label: '50ç±³(å¥³)', data: [], backgroundColor: '#f44336'},
            {label: 'ç«‹å®šè·³è¿œ(ç”·)', data: [], backgroundColor: '#9c27b0'},
            {label: 'ç«‹å®šè·³è¿œ(å¥³)', data: [], backgroundColor: '#ff9800'},
            {label: 'åä½ä½“å‰å±ˆ(ç”·)', data: [], backgroundColor: '#3f51b5'},
            {label: 'åä½ä½“å‰å±ˆ(å¥³)', data: [], backgroundColor: '#009688'},
            {label: 'é•¿è·‘(ç”·-1000)', data: [], backgroundColor: '#795548'}, 
            {label: 'é•¿è·‘(å¥³-800)', data: [], backgroundColor: '#e91e63'}, 
            {label: 'å¼•ä½“å‘ä¸Š(ç”·)', data: [], backgroundColor: '#607d8b'}, 
            {label: 'ä»°å§èµ·å(å¥³)', data: [], backgroundColor: '#ffeb3b'} 
        ]
    };
    
    sortedItemGrades.forEach(g => {
        const i = itemStats[g];
        h2 += `<tr><td>${g}</td><td>${fmt(i.lungM.c,i.lungM.t)}</td><td>${fmt(i.lungF.c,i.lungF.t)}</td><td>${fmt(i.r50M.c,i.r50M.t)}</td><td>${fmt(i.r50F.c,i.r50F.t)}</td><td>${fmt(i.jumpM.c,i.jumpM.t)}</td><td>${fmt(i.jumpF.c,i.jumpF.t)}</td><td>${fmt(i.sitM.c,i.sitM.t)}</td><td>${fmt(i.sitF.c,i.sitF.t)}</td><td>${fmt(i.runM.c,i.runM.t)}</td><td>${fmt(i.runF.c,i.runF.t)}</td><td>${fmt(i.strM.c,i.strM.t)}</td><td>${fmt(i.strF.c,i.strF.t)}</td></tr>`;
        
        itemChartData.datasets[0].data.push(getPct(i.lungM.c,i.lungM.t));
        itemChartData.datasets[1].data.push(getPct(i.lungF.c,i.lungF.t));
        itemChartData.datasets[2].data.push(getPct(i.r50M.c,i.r50M.t));
        itemChartData.datasets[3].data.push(getPct(i.r50F.c,i.r50F.t));
        itemChartData.datasets[4].data.push(getPct(i.jumpM.c,i.jumpM.t));
        itemChartData.datasets[5].data.push(getPct(i.jumpF.c,i.jumpF.t));
        itemChartData.datasets[6].data.push(getPct(i.sitM.c,i.sitM.t));
        itemChartData.datasets[7].data.push(getPct(i.sitF.c,i.sitF.t));
        itemChartData.datasets[8].data.push(getPct(i.runM.c,i.runM.t));
        itemChartData.datasets[9].data.push(getPct(i.runF.c,i.runF.t));
        itemChartData.datasets[10].data.push(getPct(i.strM.c,i.strM.t));
        itemChartData.datasets[11].data.push(getPct(i.strF.c,i.strF.t));
    });
    h2 += '</table>';
    document.getElementById('report-items').innerHTML = h2;
    renderChart('chart-items', 'bar', 'å„é¡¹ç›®ä¼˜è‰¯ç‡å¯¹æ¯” (%)', itemChartData, {yTitle: 'ä¼˜è‰¯ç‡ (%)', max: 100});

    // --- 3. ç­çº§è¯¦æƒ…åˆ†æ  ---
    let h3 = `<table class="report-table"><tr class="report-header-blue"><th>ç­çº§</th><th>æ€»æ•°</th><th>ä¼˜è‰¯ç‡</th><th>åŠæ ¼ç‡</th><th>ä¸åŠæ ¼</th></tr>`;
    const classChartData = { 
        labels: [], 
        datasets: [
            {label: 'ä¼˜è‰¯ç‡ (%)', data: [], backgroundColor: '#9c27b0'},
            {label: 'ä¸åŠæ ¼ç‡ (%)', data: [], backgroundColor: '#f44336'}
        ] 
    };
    
    Object.keys(classStats).sort((a,b)=>getClassRank(a)-getClassRank(b)).forEach(c => {
        const s = classStats[c];
        const goodPassPct = getPct(s.exc+s.good, s.tot);
        const failPct = getPct(s.fail, s.tot);

        h3 += `<tr><td>${c}</td><td>${s.tot}</td><td>${fmt(s.exc+s.good,s.tot)}</td><td>${fmt(s.tot-s.fail,s.tot)}</td><td class="${s.fail>0?'text-fail':''}">${fmt(s.fail,s.tot)}</td></tr>`;
        
        classChartData.labels.push(c);
        classChartData.datasets[0].data.push(goodPassPct);
        classChartData.datasets[1].data.push(failPct);
    });
    h3 += '</table>';
    document.getElementById('report-class').innerHTML = h3;
    renderChart('chart-class', 'bar', 'å„ç­çº§ä¼˜è‰¯ç‡ä¸ä¸åŠæ ¼ç‡ (%)', classChartData, {yTitle: 'ç™¾åˆ†æ¯” (%)', max: 100});
}

let myCharts = {};


function renderChart(canvasId, type, titleText, data, options = {}) {
    const ctx = document.getElementById(canvasId);
    
  
    if (myCharts[canvasId]) {
        myCharts[canvasId].destroy();
    }
    
    const config = {
        type: type,
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: titleText,
                    font: { size: 16, weight: 'bold' }
                },
                legend: {
                    position: 'top',
                },
                tooltip: {
                     callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            label += context.parsed.y + '%';
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'å¯¹è±¡/ç­çº§'
                    },
                    
                    ticks: {
                        autoSkip: false
                    }
                },
                y: {
                    beginAtZero: true,
                    max: options.max || undefined,
                    title: {
                        display: true,
                        text: options.yTitle || 'ç™¾åˆ†æ¯”'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + "%" 
                        }
                    }
                }
            }
        }
    };
    
    myCharts[canvasId] = new Chart(ctx, config);
}

// ==========================================
// å¯¼å‡ºç»Ÿè®¡æŠ¥å‘ŠåŠŸèƒ½
// ==========================================
function exportAnalysisExcel() {
    if (!GLOBAL_DATA.length) { alert("æ— æ•°æ®"); return; }
    
    const { stats, itemStats, classStats, existGrades } = getAnalysisData();
    const wb = XLSX.utils.book_new();

    // æ ¼å¼åŒ–å·¥å…·å‡½æ•° 
    const pct = (n,t) => t ? ((n/t)*100).toFixed(1)+'%' : '0%';
    const fmt = (n,t) => `${n} (${pct(n,t)})`;

    // --- Sheet 1: å…¨æ ¡æ±‡æ€» (é¡ºåºå·²å›ºå®šï¼Œä¿æŒä¸å˜) ---
    const s1 = [['å¯¹è±¡','æ€»æ•°','ä¼˜ç§€','ä¼˜è‰¯','åŠæ ¼','ä¸åŠæ ¼']];
    const gradeOrder = ['åˆä¸€','åˆäºŒ','åˆä¸‰','åˆä¸­','é«˜ä¸€','é«˜äºŒ','é«˜ä¸‰','é«˜ä¸­','å…¨æ ¡'];
    gradeOrder.forEach(k => {
        if(!stats[k] || stats[k].tot === 0) return;
        const s = stats[k];
        s1.push([k, s.tot, fmt(s.exc,s.tot), fmt(s.exc+s.good,s.tot), fmt(s.tot-s.fail,s.tot), fmt(s.fail,s.tot)]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s1), "å…¨æ ¡æ±‡æ€»");

    // --- Sheet 2: å„é¡¹ç›®ä¼˜è‰¯ç‡ (æ ¸å¿ƒä¿®æ”¹ï¼šå¼ºåˆ¶æŒ‰å¹´çº§é¡ºåºæ’åº) ---
    const s2 = [['å¹´çº§','è‚ºæ´»é‡(ç”·)','è‚ºæ´»é‡(å¥³)','50ç±³(ç”·)','50ç±³(å¥³)','è·³è¿œ(ç”·)','è·³è¿œ(å¥³)','åä½(ç”·)','åä½(å¥³)','1000ç±³','800ç±³','å¼•ä½“','ä»°å§']];
    
    // 1. å®šä¹‰æœŸæœ›çš„æ’åºåˆ—è¡¨
    const targetOrder = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'é«˜ä¸€', 'é«˜äºŒ', 'é«˜ä¸‰'];
    
    // 2. è¿‡æ»¤å¹¶æ’åº (åªä¿ç•™å­˜åœ¨çš„å¹´çº§)
    const sortedGrades = targetOrder.filter(g => existGrades.has(g));

    sortedGrades.forEach(g => {
        const i = itemStats[g];
        s2.push([
            g, 
            fmt(i.lungM.c,i.lungM.t), fmt(i.lungF.c,i.lungF.t), 
            fmt(i.r50M.c,i.r50M.t), fmt(i.r50F.c,i.r50F.t), 
            fmt(i.jumpM.c,i.jumpM.t), fmt(i.jumpF.c,i.jumpF.t), 
            fmt(i.sitM.c,i.sitM.t), fmt(i.sitF.c,i.sitF.t), 
            fmt(i.runM.c,i.runM.t), fmt(i.runF.c,i.runF.t), 
            fmt(i.strM.c,i.strM.t), fmt(i.strF.c,i.strF.t)
        ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s2), "å„é¡¹ç›®ä¼˜è‰¯ç‡");

    // --- Sheet 3: ç­çº§è¯¦æƒ… (é¡ºåºå·²æŒ‰ç­çº§æ’åºï¼Œä¿æŒä¸å˜) ---
    const s3 = [['ç­çº§','æ€»æ•°','ä¼˜è‰¯ç‡','åŠæ ¼ç‡','ä¸åŠæ ¼']];
    Object.keys(classStats).sort((a,b)=>getClassRank(a)-getClassRank(b)).forEach(c => {
        const s = classStats[c];
        s3.push([c, s.tot, pct(s.exc+s.good,s.tot), pct(s.tot-s.fail,s.tot), pct(s.fail,s.tot)]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s3), "ç­çº§è¯¦æƒ…");
    XLSX.writeFile(wb, 'ä½“æµ‹åˆ†ææŠ¥å‘Š.xlsx');
}
// 8ï¸âƒ£ å¯¼å‡ºç¯å¢ƒä¿¡æ¯é…ç½® (å½»åº•è§£å†³æ ‡é¢˜é‡å  & å¢åŠ æœ¬åœ°è®°å¿†)
function openEnvSettings() {
    if (!GLOBAL_DATA.length) { alert("æ— æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆ"); return; }
    updateUniqueClasses();
    
    // è¯»å–æœ¬åœ°ä¿å­˜çš„é…ç½®
    const savedConfig = JSON.parse(localStorage.getItem(ENV_STORAGE_KEY) || '{}');
    const today = new Date().toISOString().split('T')[0];
    const savedStartDate = savedConfig.startDate || today;
    const savedDefTeacher = savedConfig.defaultTeacher || '';
    const savedClassTeachers = savedConfig.classTeachers || {};

    const modalId = 'env-modal';
    let modal = document.getElementById(modalId);
    if (modal) modal.remove(); 

    const html = `
    <div id="${modalId}" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[200]">
        <div class="bg-white rounded-lg shadow-xl w-[600px] max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-purple-600 text-white rounded-t-lg">
                <h3 class="font-bold text-lg">ğŸ“… å¯¼å‡ºæµ‹è¯•ç¯å¢ƒé…ç½®</h3>
                <button onclick="document.getElementById('${modalId}').remove()" class="text-white hover:text-gray-200 text-xl">Ã—</button>
            </div>
            
            <div class="p-4 flex flex-col overflow-hidden flex-1">
                <div class="mb-4 bg-gray-50 p-3 rounded border shrink-0">
                    <div class="flex gap-4 items-center mb-2">
                        <label class="w-24 font-bold text-right text-gray-700">æµ‹è¯•æ—¥æœŸ:</label>
                        <input type="date" id="env-start-date" value="${savedStartDate}" class="border p-1 rounded flex-1">
                    </div>
                    <div class="flex gap-4 items-center">
                        <label class="w-24 font-bold text-right text-gray-700">é»˜è®¤è€å¸ˆ:</label>
                        <input type="text" id="env-def-teacher" value="${savedDefTeacher}" class="border p-1 rounded flex-1" placeholder="æ‰¹é‡å¡«å……å§“å">
                        <button onclick="applyDefaultTeacher()" class="btn btn-blue text-xs ml-2">åº”ç”¨å…¨éƒ¨</button>
                    </div>
                </div>

                <div class="border rounded border-gray-300 flex flex-col flex-1 bg-white overflow-hidden">
                    <div class="flex bg-gray-100 border-b shrink-0 font-bold text-gray-700 shadow-sm">
                        <div class="w-1/3 p-3 border-r text-center">ç­çº§</div>
                        <div class="w-2/3 p-3 text-center">æµ‹è¯•è€å¸ˆ</div>
                    </div>
                    <div class="overflow-y-auto flex-1">
                        <table class="w-full text-sm border-collapse">
                            <tbody>
                                ${UNIQUE_CLASSES.map(cls => `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="w-1/3 p-2 border-r text-center font-medium text-gray-600">${cls}</td>
                                        <td class="w-2/3 p-2">
                                            <input type="text" class="env-cls-teacher w-full border border-gray-200 rounded px-2 py-1 text-center" 
                                                data-cls="${cls}" value="${savedClassTeachers[cls] || ''}" placeholder="é»˜è®¤è€å¸ˆ">
                                        </td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t flex justify-end gap-2 bg-gray-50 rounded-b-lg">
                <button onclick="document.getElementById('${modalId}').remove()" class="btn btn-red">å–æ¶ˆ</button>
                <button onclick="generateEnvExcel()" class="btn btn-green">ğŸ“¤ ç¡®è®¤å¯¼å‡ºå¹¶ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
}

// è¾…åŠ©åŠŸèƒ½ï¼šä¸€é”®å¡«å……è€å¸ˆ
function applyDefaultTeacher() {
    const def = document.getElementById('env-def-teacher').value;
    if(!def) { alert("è¯·å…ˆè¾“å…¥é»˜è®¤è€å¸ˆå§“å"); return; }
    document.querySelectorAll('.env-cls-teacher').forEach(input => {
        input.value = def;
    });
}

// è¾…åŠ©ï¼šä¸€é”®åº”ç”¨é»˜è®¤è€å¸ˆåˆ°æ‰€æœ‰è¾“å…¥æ¡†
function applyDefaultTeacher() {
    const def = document.getElementById('env-def-teacher').value;
    if(!def) { alert("è¯·å…ˆè¾“å…¥é»˜è®¤è€å¸ˆå§“å"); return; }
    document.querySelectorAll('.env-cls-teacher').forEach(input => {
        input.value = def;
    });
}

// æ‰§è¡Œå¯¼å‡ºç¯å¢ƒä¿¡æ¯ (ä¸¥æ ¼æŒ‰ç…§å›¾ç‰‡ å¡«å†™å™¨æ)
window.generateEnvExcel = function() {
    const startDateStr = document.getElementById('env-start-date').value;
    const defTeacher = document.getElementById('env-def-teacher').value;
    if (!startDateStr) { alert('è¯·é€‰æ‹©æ—¥æœŸ'); return; }

    const classTeachers = {};
    document.querySelectorAll('.env-cls-teacher').forEach(input => {
        classTeachers[input.dataset.cls] = input.value;
    });

    // è‡ªåŠ¨ä¿å­˜é…ç½®
    localStorage.setItem(ENV_STORAGE_KEY, JSON.stringify({
        startDate: startDateStr,
        defaultTeacher: defTeacher,
        classTeachers: classTeachers
    }));

    document.getElementById('env-modal').remove();

    const juniorClasses = [], seniorClasses = [], classBatchOffset = {};
    UNIQUE_CLASSES.forEach(cls => {
        const info = getEntryYearInfo(cls);
        (info.stage === '3' || cls.includes('é«˜')) ? seniorClasses.push(cls) : juniorClasses.push(cls);
    });
    const BATCH = 4;
    juniorClasses.forEach((cls, i) => classBatchOffset[cls] = Math.floor(i / BATCH));
    seniorClasses.forEach((cls, i) => classBatchOffset[cls] = Math.floor(i / BATCH));

    // ä¸¥æ ¼æŒ‰ç…§å›¾ç‰‡ è¦æ±‚çš„å™¨æåˆ—è¡¨
    const itemsConfig = [
        { name: 'èº«é«˜', tool: 'èº«é«˜ä½“é‡ä»ª', group: 0 },
        { name: 'ä½“é‡', tool: 'èº«é«˜ä½“é‡ä»ª', group: 0 },
        { name: 'è‚ºæ´»é‡', tool: 'è‚ºæ´»é‡ä»ª', group: 0 },
        { name: '50ç±³è·‘', tool: 'ç§’è¡¨', group: 1 },
        { name: 'ç«‹å®šè·³è¿œ', tool: 'çš®å°º', group: 2 },
        { name: 'åä½ä½“å‰å±ˆ', tool: 'æµ‹è¯•ä»ª', group: 3 },
        { name: '1000ç±³è·‘', tool: 'ç§’è¡¨', group: 4 },
        { name: 'å¼•ä½“å‘ä¸Š', tool: 'å•æ ', group: 5 },
        { name: '800ç±³è·‘', tool: 'ç§’è¡¨', group: 6 },
        { name: 'ä¸€åˆ†é’Ÿä»°å§èµ·å', tool: 'ä»°å§å«', group: 7 }
    ];

    const wb = XLSX.utils.book_new();
    const sheetData = [['å¹´çº§', 'ç­çº§ç­å·', 'ç­çº§åç§°', 'é¡¹ç›®åç§°', 'æµ‹è¯•è€å¸ˆ', 'æµ‹è¯•æ—¶é—´', 'æµ‹è¯•åœ°ç‚¹', 'æµ‹è¯•å™¨æ', 'æµ‹è¯•æ–¹å¼(æ‰‹å·¥/ä»ªå™¨)']];

    UNIQUE_CLASSES.forEach(clsName => {
        const sample = GLOBAL_DATA.find(d => d.gc === clsName);
        const batchOffset = classBatchOffset[clsName] || 0;
        const teacher = classTeachers[clsName] || defTeacher || 'æœªæŒ‡å®š';
        
        itemsConfig.forEach(item => {
            const testDate = getWorkDate(startDateStr, batchOffset + item.group);
            sheetData.push([
                sample ? sample.gradeId : '', 
                sample ? sample.classId : '', 
                getStandardClassName(clsName),
                item.name, 
                teacher, 
                testDate, 
                'æ“åœº', 
                item.tool, 
                'ä»ªå™¨'
            ]);
        });
    });

    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let R = 1; R <= range.e.r; ++R) {
        const cell = ws[XLSX.utils.encode_cell({r: R, c: 5})];
        if (cell && cell.v instanceof Date) { cell.t = 'd'; cell.z = 'yyyy/m/d'; }
    }
    ws['!cols'] = [{wch:10},{wch:12},{wch:18},{wch:15},{wch:12},{wch:12},{wch:10},{wch:15},{wch:20}];
    XLSX.utils.book_append_sheet(wb, ws, "ç¯å¢ƒä¿¡æ¯");
    XLSX.writeFile(wb, 'å…¨æ ¡æµ‹è¯•ç¯å¢ƒä¿¡æ¯è¡¨.xlsx');
};
function scrollToNextWarn() {
    if(WARN_LIST.length === 0) return;
    const globalIdx = WARN_LIST[WARN_PTR];
    const targetData = GLOBAL_DATA[globalIdx];
    const targetClass = targetData.gc || 'æœªåˆ†ç±»';
    updateUniqueClasses();
    const classIdx = UNIQUE_CLASSES.indexOf(targetClass);
    if(classIdx !== -1 && classIdx !== CUR_CLASS_IDX) { CUR_CLASS_IDX = classIdx; renderTable(); }
    setTimeout(() => {
        const tr = document.querySelector(`tr[data-idx="${globalIdx}"]`);
        if(tr) { tr.scrollIntoView({behavior: "smooth", block: "center"}); tr.classList.add('row-focus-error'); setTimeout(() => tr.classList.remove('row-focus-error'), 3000); }
    }, 100);
    WARN_PTR = (WARN_PTR + 1) % WARN_LIST.length;
    document.getElementById('btnWarnNav').innerText = `âš ï¸ å®šä½å¼‚å¸¸ (${WARN_PTR + 1}/${WARN_LIST.length})`;
}

// ç›‘å¬è¾“å…¥
document.getElementById('visionTableBody').addEventListener('input', e => { if(e.target.tagName==='INPUT') { VISION_DATA[parseInt(e.target.closest('tr').dataset.idx)][e.target.dataset.f] = e.target.value; debounceSave(); } });
document.getElementById('tableBody').addEventListener('input', e => { if(e.target.tagName==='INPUT') { GLOBAL_DATA[parseInt(e.target.closest('tr').dataset.idx)][e.target.dataset.f] = e.target.value; debounceSave(); } });

// åˆå§‹åŒ–
let sh = ''; for(let i=0; i<9; i++) sh += '<th class="bg-header-score col-w-xs">å¾—åˆ†</th><th class="bg-header-score col-w-xs">ç­‰çº§</th>';
document.getElementById('subHeader').innerHTML = sh;
loadData();
</script>
</body>
</html>
